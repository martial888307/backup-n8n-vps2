{"createdAt":"2025-10-22T09:40:06.988Z","updatedAt":"2025-10-25T10:17:49.000Z","id":"nG775fRHXrX2BwFQ","name":"support_changeStatus","active":true,"isArchived":false,"nodes":[{"parameters":{},"type":"n8n-nodes-base.manualTrigger","typeVersion":1,"position":[-272,-160],"id":"52c07f64-5971-4065-b928-5bf8fca12d01","name":"When clicking ‘Execute workflow’"},{"parameters":{"fromEmail":"=support@eurekia.io","toEmail":"={{ $json.to }}","subject":"={{ $json.subject }}","emailFormat":"both","text":"={{ $json.text }}","html":"={{ $json.html }}","options":{"ccEmail":"martial@eurekia.io"}},"type":"n8n-nodes-base.emailSend","typeVersion":2.1,"position":[624,-160],"id":"7c72989a-28a7-4868-abef-3cacdc450166","name":"Send email","webhookId":"a316e446-3a62-462c-9256-7d4f9f49e7e9","credentials":{"smtp":{"id":"rp2FwQuZzPyHzlx9","name":"SMTP account"}}},{"parameters":{"resource":"databasePage","operation":"update","pageId":{"__rl":true,"value":"={{ $json.id }}","mode":"id"},"propertiesUi":{"propertyValues":[{"key":"is_repondu_email|checkbox","checkboxValue":true}]},"options":{}},"type":"n8n-nodes-base.notion","typeVersion":2.2,"position":[192,32],"id":"54dfdbe2-ea4c-451f-8c50-415e01d80423","name":"Update is_Repondu check","credentials":{"notionApi":{"id":"q0dbCGRA3dXKCUXG","name":"Notion account"}}},{"parameters":{"rule":{"interval":[{"field":"hours"}]}},"type":"n8n-nodes-base.scheduleTrigger","typeVersion":1.2,"position":[-272,16],"id":"f7a95dc3-1f0f-4f9d-80b5-2e12707b2c37","name":"Schedule Trigger"},{"parameters":{"jsCode":"// Entrée attendue : [{ email, tickets: [{titre, description, url, statut, reponse}, ...] }, ...]\nconst groups = $input.all();\n\nfunction cleanDesc(str = '', max = 300) {\n  // Retire les [cid:...] et <mailto:...> et compresse les espaces\n  let s = str\n    .replace(/\\[cid:[^\\]]+\\]/g, '')\n    .replace(/<mailto:[^>]+>/g, '')\n    .replace(/\\s{2,}/g, ' ')\n    .trim();\n  if (s.length > max) s = s.slice(0, max) + '…';\n  return s;\n}\n\nfunction htmlEscape(s = '') {\n  return s\n    .replace(/&/g, '&amp;')\n    .replace(/</g, '&lt;')\n    .replace(/>/g, '&gt;');\n}\n\nconst items = [];\n\nfor (const g of groups) {\n  const to = g.json.email || 'unknown@example.com';\n  const tickets = Array.isArray(g.json.tickets) ? g.json.tickets : [];\n\n  // Texte brut\n  const lines = tickets.map(t =>\n    [\n      `URL: ${t.url || ''}`,\n      `Statut: ${t.statut || ''}`,\n      `Titre: ${t.titre || ''}`,\n      `Description: ${cleanDesc(t.description)}`,\n      `Réponse: ${cleanDesc(t.reponse)}`\n    ].join('\\n')\n  );\n\n  // Tableau HTML\n  const rows = tickets.map((t, i) => {\n    const desc = htmlEscape(cleanDesc(t.description));\n    const titre = htmlEscape(t.titre || '');\n    const statut = htmlEscape(t.statut || '');\n    const url = t.url ? `<a href=\"${t.url}\" target=\"_blank\">${t.url}</a>` : '';\n    const reponse = htmlEscape(cleanDesc(t.reponse));\n    const bg = i % 2 === 0 ? '#ffffff' : '#f9fafc';\n    return `\n      <tr style=\"background:${bg};\">\n        <td style=\"padding:10px;vertical-align:top;border:1px solid #dee2e6;\">${url}</td>\n        <td style=\"padding:10px;vertical-align:top;border:1px solid #dee2e6;\">${statut}</td>\n        <td style=\"padding:10px;vertical-align:top;border:1px solid #dee2e6;\">${titre}</td>\n        <td style=\"padding:10px;vertical-align:top;border:1px solid #dee2e6;\">${desc}</td>\n        <td style=\"padding:10px;vertical-align:top;border:1px solid #dee2e6;\">${reponse}</td>\n      </tr>`;\n  }).join('');\n\n  const textBody =\n`Bonjour,\n\nLes tickets suivants ont changé de statut :\n\n${lines.map(l => `—\\n${l}`).join('\\n\\n')}\n\nBonne journée,`;\n\n  const htmlBody = `\n<div style=\"font-family:Arial,Helvetica,sans-serif;font-size:14px;line-height:1.5;color:#333;\">\n  <p>Bonjour,</p>\n  <p>Les tickets suivants ont changé de statut :</p>\n  <table cellpadding=\"0\" cellspacing=\"0\" style=\"border-collapse:collapse;min-width:600px;border:1px solid #dee2e6;\">\n    <thead>\n      <tr style=\"background-color:#f0f4f8;color:#333;text-align:left;\">\n        <th style=\"padding:10px;border:1px solid #dee2e6;\">URL</th>\n        <th style=\"padding:10px;border:1px solid #dee2e6;\">Statut</th>\n        <th style=\"padding:10px;border:1px solid #dee2e6;\">Titre</th>\n        <th style=\"padding:10px;border:1px solid #dee2e6;\">Description</th>\n        <th style=\"padding:10px;border:1px solid #dee2e6;\">Réponse</th>\n      </tr>\n    </thead>\n    <tbody>\n      ${rows}\n    </tbody>\n  </table>\n  <p style=\"margin-top:20px;\">Bonne journée,</p>\n</div>`;\n\n  items.push({\n    json: {\n      to,\n      subject: `📝 ${tickets.length} ticket(s) ont changé de statut`,\n      text: textBody,\n      html: htmlBody,\n    }\n  });\n}\n\nreturn items;"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[400,-160],"id":"817d5212-c444-44e8-a757-cdee4c9074b6","name":"paramétrage email"},{"parameters":{"jsCode":"// Récupérer tous les items d'entrée\nconst items = $input.all();\n\n// Dictionnaire pour regrouper par adresse email\nconst grouped = {};\n\nfor (const item of items) {\n  const data = item.json;\n  const email = data.properties?.fromEmail?.email || 'unknown';\n\n  // Extraire les champs demandés\n  const titre = data.properties?.Titre?.title?.[0]?.plain_text || '';\n  const description = data.properties?.Description?.rich_text?.[0]?.plain_text || '';  \n  const reponse = data.properties?.reponse?.rich_text?.[0]?.plain_text || '';\n  const url = data.url || '';\n  const statut = data.properties?.Statut?.status?.name || '';\n\n  if (!grouped[email]) {\n    grouped[email] = [];\n  }\n\n  grouped[email].push({\n    titre,\n    description,\n    reponse,\n    url,\n    statut\n  });\n}\n\n// Transformer le regroupement en tableau d'items n8n\nreturn Object.keys(grouped).map(email => ({\n  json: {\n    email,\n    tickets: grouped[email]\n  }\n}));"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[192,-160],"id":"ca04abec-8832-4bf3-b9a2-2c5ea7d96c81","name":"extraction infos"},{"parameters":{"resource":"databasePage","operation":"getAll","databaseId":{"__rl":true,"value":"d38ecf86-28d2-47de-b069-1b33e2d4229c","mode":"list","cachedResultName":"Tickets client","cachedResultUrl":"https://www.notion.so/d38ecf8628d247deb0691b33e2d4229c"},"simple":false,"filterType":"manual","matchType":"allFilters","filters":{"conditions":[{"key":"Statut|status","condition":"equals","statusValue":"Résolu"},{"key":"is_repondu_email|checkbox","condition":"equals"}]},"options":{}},"type":"n8n-nodes-base.notion","typeVersion":2.2,"position":[-16,-160],"id":"2bddd1ec-6e13-447e-9f3a-559558bb83c8","name":"get pages resolues","credentials":{"notionApi":{"id":"q0dbCGRA3dXKCUXG","name":"Notion account"}}}],"connections":{"When clicking ‘Execute workflow’":{"main":[[{"node":"get pages resolues","type":"main","index":0}]]},"Send email":{"main":[[]]},"Update is_Repondu check":{"main":[[]]},"Schedule Trigger":{"main":[[{"node":"get pages resolues","type":"main","index":0}]]},"paramétrage email":{"main":[[{"node":"Send email","type":"main","index":0}]]},"extraction infos":{"main":[[{"node":"paramétrage email","type":"main","index":0}]]},"get pages resolues":{"main":[[{"node":"Update is_Repondu check","type":"main","index":0},{"node":"extraction infos","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","callerPolicy":"workflowsFromSameOwner","errorWorkflow":"4xKLB9RPfrowY9h4"},"staticData":{"node:Schedule Trigger":{"recurrenceRules":[]}},"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"4cca2120-f339-4671-8f57-f7ae2fd40edb","triggerCount":1,"shared":[{"createdAt":"2025-10-22T09:40:06.993Z","updatedAt":"2025-10-22T09:40:06.993Z","role":"workflow:owner","workflowId":"nG775fRHXrX2BwFQ","projectId":"3csiRTB7Dv0MNPzt"}],"tags":[]}