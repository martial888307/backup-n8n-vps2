{"createdAt":"2025-10-01T14:53:52.621Z","updatedAt":"2025-10-01T14:53:52.621Z","id":"FvKy9e0sari5gT9p","name":"sapitec_retreive-emails-supabase copy 2025_10_01","active":false,"isArchived":false,"nodes":[{"parameters":{"tableId":"emails","fieldsUi":{"fieldValues":[{"fieldId":"gmail_id","fieldValue":"={{ $json.email_id }}"},{"fieldId":"subject","fieldValue":"={{ $json.subject }}"},{"fieldId":"content","fieldValue":"=Exp√©diteur : {{ $('getEmailAndAttach').item.json.from.text }}\n------------------\n\n{{ $json.body }}"},{"fieldId":"email_date","fieldValue":"={{ new Date($('getEmailAndAttach').item.json.date).toLocaleString('sv-SE', { timeZone: 'Europe/Paris' }).replace(' ', 'T') }}"},{"fieldId":"from_email","fieldValue":"={{ (() => { \n  const raw = $('getEmailAndAttach').item.json.from?.text;\n  if (!raw) return null; // si vide/undefined -> null\n  const str = Array.isArray(raw) ? raw[0] : raw;\n  return (str.match(/<([^>]+)>/)?.[1] \n       || str.match(/[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\\.[A-Za-z]{2,}/)?.[0] \n       || null);\n})() }}"},{"fieldId":"to_email","fieldValue":"={{ (() => { \n  const raw = $('getEmailAndAttach').item.json.to?.text;\n  if (!raw) return null; // si vide/undefined -> null\n  const str = Array.isArray(raw) ? raw[0] : raw;\n  return (str.match(/<([^>]+)>/)?.[1] \n       || str.match(/[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\\.[A-Za-z]{2,}/)?.[0] \n       || null);\n})() }}"}]}},"id":"da5a2437-4ef9-4525-9df2-cd63983ce05c","name":"Insert Email","type":"n8n-nodes-base.supabase","typeVersion":1,"position":[-1104,112],"credentials":{"supabaseApi":{"id":"c6pA96O6wOcfq8wb","name":"Supabase account"}}},{"parameters":{"method":"POST","url":"=https://supabasekong.eurekia-solutions.com/storage/v1/object/email-attachments/{{ $json.file_path }}","authentication":"genericCredentialType","genericAuthType":"httpBearerAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"  x-upsert","value":"true"}]},"sendBody":true,"contentType":"binaryData","inputDataFieldName":"data","options":{}},"name":"Upload to Storage","type":"n8n-nodes-base.httpRequest","position":[-1104,640],"id":"c87cfb0d-7718-4177-87cf-7632686a5d19","typeVersion":4.2,"credentials":{"httpBearerAuth":{"id":"LcmmlniTWcYXU9cu","name":"Bearer Auth supabase SERVICE KEY"}},"onError":"continueErrorOutput"},{"parameters":{"tableId":"email_attachments","fieldsUi":{"fieldValues":[{"fieldId":"email_id","fieldValue":"={{ $json.email_id }}"},{"fieldId":"file_name","fieldValue":"={{ $json.file_name }}"},{"fieldId":"file_path","fieldValue":"={{ $json.file_path }}"},{"fieldId":"file_type","fieldValue":"={{ $json.file_type }}"}]}},"name":"Insert Attachment Row","type":"n8n-nodes-base.supabase","position":[384,432],"id":"4767d1d8-dfd1-4f10-a16e-d46d4ed3cd32","typeVersion":1,"credentials":{"supabaseApi":{"id":"c6pA96O6wOcfq8wb","name":"Supabase account"}}},{"parameters":{"jsCode":"const output = [];\n\nfor (const item of $input.all()) {\n  const emailId = item.json.id;\n\n  // PJ binaires\n  if (item.binary && Object.keys(item.binary).length > 0) {\n    for (const [key, binaryData] of Object.entries(item.binary)) {\n      output.push({\n        json: {\n          email_id: emailId,\n          attachmentName: binaryData.fileName || key,\n          contentType: binaryData.mimeType || 'unknown',\n        },\n        binary: {\n          data: binaryData\n        }\n      });\n    }\n  }\n\n  // PJ dans json.attachments (si applicable)\n  else if (Array.isArray(item.json.attachments)) {\n    for (const attachment of item.json.attachments) {\n      output.push({\n        json: {\n          gmail_id: emailId,\n          attachmentId: attachment.attachmentId,\n          filename: attachment.filename,\n          mimeType: attachment.mimeType,\n          size: attachment.size\n        }\n      });\n    }\n  }\n}\n\nreturn output;"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-1760,704],"id":"d4bfb8da-7c1f-476d-96eb-1a38c478d9d1","name":"split attachments"},{"parameters":{"jsCode":"const output = [];\n\nfor (const item of $input.all()) {\n  // ID de l‚Äôe-mail (priorit√© √† email_id s‚Äôil existe)\n  const emailId = item.json.email_id ?? item.json.id;\n  if (!emailId) continue;\n\n  // Sujet : ¬´ non defini ¬ª si vide ou absent\n  const subject = (item.json.subject && item.json.subject.trim())\n    ? item.json.subject\n    : 'non defini';\n\n  // Corps : text en priorit√©, sinon html, sinon cha√Æne vide\n  const body = item.json.text ?? item.json.html ?? '';\n\n  // Comptage des pi√®ces jointes\n  let count = 0;\n  if (item.binary && typeof item.binary === 'object' && Object.keys(item.binary).length) {\n    count = Object.keys(item.binary).length;\n  } else if (Array.isArray(item.json.attachments)) {\n    count = item.json.attachments.length;\n  }\n\n  // Construction de la sortie\n  output.push({\n    json: {\n      email_id: emailId,\n      subject,\n      body,\n      attachments_count: count\n    }\n  });\n}\n\nreturn output;"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-1536,112],"id":"93f4719d-38fe-434b-9400-ab4b6b0dead5","name":"Code"},{"parameters":{"jsCode":"const output = [];\n\nconst seen = new Set();\n\nfor (const item of $input.all()) {\n  const emailId = item.json.id;\n  const gmailId = item.json.gmail_id;\n\n  if (!emailId || !gmailId || seen.has(gmailId)) {\n    continue;\n  }\n\n  seen.add(gmailId);\n\n  output.push({\n    json: {\n      email_id: emailId,\n      gmail_id: gmailId\n    }\n  });\n}\n\nreturn output;"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-656,432],"id":"af25bdbd-3a2f-449d-8686-cc980386fd86","name":"Code1","onError":"continueErrorOutput"},{"parameters":{"mode":"combine","fieldsToMatchString":"gmail_id","options":{}},"type":"n8n-nodes-base.merge","typeVersion":3.1,"position":[-448,512],"id":"e0379312-db5f-453f-9c10-6c0abe176b35","name":"Merge"},{"parameters":{"model":{"__rl":true,"value":"gpt-4.1-mini","mode":"list","cachedResultName":"gpt-4.1-mini"},"options":{"temperature":0.2}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[80,224],"id":"c043fbda-01a9-49ce-8755-d1461271b975","name":"OpenAI Chat Model","credentials":{"openAiApi":{"id":"w9SlUWDfkUpRmR78","name":"OpenAi account"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"87a4e923-e491-4f86-9cfb-313144983569","leftValue":"={{ $('getEmailAndAttach').item.json.text }}","rightValue":"","operator":{"type":"string","operation":"empty","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-880,112],"id":"712a3e34-eaba-4c0c-8cbd-2b2eeb618906","name":"If"},{"parameters":{"assignments":{"assignments":[{"id":"a312b388-e756-4e0b-8739-70a2df174ba3","name":"prompt","value":"={{ $('getEmailAndAttach').item.json.html }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-656,32],"id":"da3c0fc3-3011-4e2a-8ea2-7b0ea912f32d","name":"Edit Fields1"},{"parameters":{"assignments":{"assignments":[{"id":"00b70686-2440-4830-bf9a-ff6fdad0c5c8","name":"prompt","value":"={{ $('getEmailAndAttach').item.json.text }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-656,240],"id":"51df2d49-1521-4e3b-82b2-cf612eb5569d","name":"Edit Fields2"},{"parameters":{"fieldToSplitOut":"prompt","include":"selectedOtherFields","fieldsToInclude":"idEmail, threadId","options":{}},"type":"n8n-nodes-base.splitOut","typeVersion":1,"position":[-448,112],"id":"6aa5404e-57fd-40f6-9103-7099fd9f59c0","name":"Split Out"},{"parameters":{"assignments":{"assignments":[{"id":"9a185dc7-4970-4f44-bc2f-cf899a7882b6","name":"prompt","value":"={{ $json.prompt }}","type":"string"},{"id":"4afbab65-2fb1-4b71-bf65-faee9c1e5db9","name":"id_email","value":"={{ $('If').item.json.id }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-224,112],"id":"9d96c614-f4cc-413c-924a-956e536e2208","name":"prompt"},{"parameters":{"mode":"combine","combineBy":"combineByPosition","options":{}},"type":"n8n-nodes-base.merge","typeVersion":3.1,"position":[384,112],"id":"4999c1a1-64d2-44db-ac02-81f98c135ab8","name":"Merge1"},{"parameters":{"text":"=Voici le texte e-mail √† analyser et cat√©goriser : {{ $json.prompt }}","schemaType":"fromJson","jsonSchemaExample":"{\n  \"type\": \"suivi\",\n  \"titre\": \"Absence de devis joint\",\n  \"objet\": \"Demande de renvoi du devis r√©actualis√© pour ESPACE EMERAUDE BAT C/D\",\n  \"url_info\": \"https://...\",\n  \"url_password\": \"2354\",\n  \"reference\": \"0197\",\n  \"client\": {\n    \"raisonSociale\": \"SOGELEM\",\n    \"nomPrenom\": \"Bryan Briard\",\n    \"adresse\": \"12, Cours Emile Zola\",\n    \"codePostal\": \"69100\",\n    \"ville\": \"Villeurbanne\",\n    \"tel\": \"04 72 98 25 21\",\n    \"email\": \"bryan.briard@sogelem.fr\"\n  },\n  \"lese\": {\n    \"nomPrenom\": \"Gaelle Jos\",\n    \"adresse\": \"Immeuble les Fleurs\\r4rue de la paix\",\n    \"codePostal\": \"75008\",\n    \"ville\": \"Paris\",\n    \"tel\": \"04 72 98 25 21\",\n    \"email\": \"gaelle.jos@sogelem.fr\"\n  }\n}","options":{"systemPromptTemplate":"=Vous √™tes l'assistant d‚Äôanalyse d‚Äôe-mails fran√ßais de la soci√©t√© SAPITEC qui re√ßoit des emails de ses clients (R√©gies, Syndics en majorit√©) parlant d'intervention √† faire dans des r√©sidences chez des particuliers (le l√©s√©).\n\nLes emails analys√©s peuvent √™tre des emails tranf√©r√©s en interne : il faut ignorer les noms, coordonn√©es et adresses emails des personnes semblant travailler chez SAPITEC. \n\nVotre t√¢che est purement extractive : ne gardez que les informations pr√©sentes explicitement dans l‚Äôe-mail.  \nIgnorez les noms, coordonn√©es et adresses emails des personnes travaillant chez SAPITEC.  \n\nChamps √† produire :\n- Type : <suivi | demande | commande | autre> (obligatoire, jamais vide)  \n- titre : r√©sum√© court de l‚Äôemail (jamais vide)\n\nurl\n - parfois une url est indique pour un compl√©ment d'information, t√©l√©charger une commande ou d√©poser un devis : √† mettre dans url_info\n - il arrive que l'url soit fournie avec un mot de passe qui permet d'acc√©der au site de la r√©gie, √† renseigner dans url_password\n\n- Client : nom du client, eng√©nral celui qui √©crit l'email et donne les instructions (ou vide si non trouv√©)\n\n- Contact client : en g√©n√©ral celui qui signe l'email\n\n- Details : r√©sum√© concis en reprenant les mots originaux quand possible (ou vide)  \n\n- adresse : \n\n  ‚Ä¢ Num√©ro de voie + nom de voie  \n  ‚Ä¢ Ne jamais inclure le code postal ni la ville  \n- code postal : 5 chiffres si pr√©sent  \n- ville : mot(s) qui suivent imm√©diatement le code postal  \n\nLe l√©s√© :\n\nParfois le nom du l√©s√© n'est pas stipul√© mais l'adresse l'est, souvent avec le nom de l'immeuble ou de la r√©sidence dans ces cas : bien remplir les informations l√©s√© sans stipuler le nom pr√©nom juste.\n\n - Adresse l√©s√© : Peut contenir ‚Äúimmeuble‚Äù, ‚Äúr√©sidence‚Äù, ‚Äúcopropri√©t√©‚Äù, ‚Äúb√¢timent‚Äù si pr√©sent. si tu trouves le nom associ√© le mettre avant l'adresse. Exemple \"Le Clos Fleuri - 29 rue Pierre Brunier\"\n - nom pr√©nom : peut √™tre d√©fini comme le \"contact sur place\" ou \"le membre de la copropri√©t√©\" ou \"le locataire\" ou toute appellation qui fait penser que c'est la personne chez qui il faut intervenir, quand son nom est pr√©cis√©.\n\nCat√©gorisation du champ Type :\n- suivi : relance, question, √©change d√©j√† en cours  \n- demande : premi√®re demande de prix (souvent via un lien ou formulaire)  \n- commande : accord explicite suite √† un devis  \n- autre : paiements, communications internes, hors p√©rim√®tre  \n\nR√®gles imp√©ratives :\n- Le champ Type est toujours obligatoire  \n- Si aucune cat√©gorie ne correspond ‚Üí √©crire ¬´ autre ¬ª  \n- Si une information n‚Äôest pas clairement pr√©sente ‚Üí laisser vide  \n- Ne pas √©crire ‚ÄúN/A‚Äù, ‚Äúexemple‚Äù ou une valeur fictive  \n- Ne jamais mettre ‚ÄúSAPITEC‚Äù comme client\n\nFormat de sortie JSON comme indiqu√© dans l'exemple.\n** IMPORTANT ** renseigner toutes les cl√©s attendues, par exemple si nomPrenom du l√©s√© est vide le mettre dans le json et mettre vide (\"\")\n\nExemples de format attendu (illustratifs uniquement) :\n\nEntr√©e :\n¬´ Sauf erreur de notre part, nous n‚Äôavons pas eu de confirmation pour la demande suivante : ¬ª  \nSortie :\nType: suivi  \ntitre: Relance client affaire xxx  \n\nEntr√©e :\n¬´ Peux tu reprendre rendez-vous avec‚Ä¶ ¬ª  \nSortie :\nType: suivi  \ntitre: Suivi de RDV affaire xxx  \n\nEntr√©e :\n¬´ Veuillez prendre connaissance de notre envoi via ce lien : https://formulaire-devis.example.com ¬ª  \nSortie :\nType: demande  \ntitre: Demande de devis affaire xxx  \n\nEntr√©e :\n¬´ Nous confirmons notre commande pour le devis #1234. ¬ª  \nSortie :\nType: commande  \ntitre: Confirmation de commande pour le devis #1234  "}},"type":"@n8n/n8n-nodes-langchain.informationExtractor","typeVersion":1,"position":[0,0],"id":"f94c3670-5d96-48bb-8f37-350b6489f253","name":"cat√©goriser email","onError":"continueErrorOutput"},{"parameters":{"rule":{"interval":[{"field":"minutes","minutesInterval":10}]}},"type":"n8n-nodes-base.scheduleTrigger","typeVersion":1.2,"position":[-3088,1312],"id":"ef85b58a-0f6f-4e84-b9b2-db8f88186f30","name":"Schedule Trigger"},{"parameters":{"operation":"getAll","limit":2,"filters":{"labelIds":["Label_1308286277154146398"]},"path":"d339737e-c604-4ace-976d-f035f8ddfe1f"},"type":"n8n-nodes-base.gmail","typeVersion":2.1,"position":[-2416,1104],"id":"3d1abeec-eff2-4adf-a89a-a9a5d18d1a9c","name":"getEmais","webhookId":"d339737e-c604-4ace-976d-f035f8ddfe1f","credentials":{"gmailOAuth2":{"id":"g5jOu8vwcyLtJevm","name":"Gmail account Sapitec"}},"onError":"continueErrorOutput"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"b7378f2a-cc8c-4744-9406-0b2a92b166ce","leftValue":"={{ $json.From }}","rightValue":"3CX","operator":{"type":"string","operation":"contains"}},{"id":"74b601d5-4f37-48d7-9833-f68391725a8f","leftValue":"={{ $json.snippet }}","rightValue":"=^-- RAPPEL --","operator":{"type":"string","operation":"regex"}}],"combinator":"or"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-2208,1200],"id":"1ea8dcee-5008-498d-a8ee-d88aa241c4b5","name":"testFrom"},{"parameters":{"assignments":{"assignments":[{"id":"048ac137-749b-4341-affb-4c7a3ee1d7f0","name":"test","value":false,"type":"boolean"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-2864,1200],"id":"b061f6cd-4580-41a5-b735-9211d6c58059","name":"_isTest"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"ebb11565-64cb-4fda-a8ce-65dbede92410","leftValue":"={{ $json.test }}","rightValue":"","operator":{"type":"boolean","operation":"false","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-2640,1200],"id":"ac8a0f59-5fce-4c42-afe7-dc968b87c2ab","name":"If2"},{"parameters":{"operation":"getAll","limit":2,"filters":{"labelIds":["Label_3039467312286841064"]},"path":"b8df5cc4-90e8-4d54-a515-6707b7b130f3"},"type":"n8n-nodes-base.gmail","typeVersion":2.1,"position":[-2416,1312],"id":"b3205660-ab63-4981-b251-b135aea45a6d","name":"getEmail TEST","webhookId":"b8df5cc4-90e8-4d54-a515-6707b7b130f3","credentials":{"gmailOAuth2":{"id":"g5jOu8vwcyLtJevm","name":"Gmail account Sapitec"}}},{"parameters":{"operation":"get","messageId":"={{ $json.id }}","simple":false,"options":{"downloadAttachments":true},"path":"8b03ffa5-ab56-42d8-b245-5b20de2917bf"},"type":"n8n-nodes-base.gmail","typeVersion":2.1,"position":[-1984,960],"id":"17d05677-b81e-4919-a955-3f3b737dd30e","name":"getEmailAndAttach","webhookId":"8b03ffa5-ab56-42d8-b245-5b20de2917bf","credentials":{"gmailOAuth2":{"id":"g5jOu8vwcyLtJevm","name":"Gmail account Sapitec"}}},{"parameters":{"operation":"removeLabels","messageId":"={{ $json.id }}","labelIds":["INBOX","Label_1308286277154146398"],"path":"ff04b398-6e69-449f-83b8-90e16d3416bc"},"type":"n8n-nodes-base.gmail","typeVersion":2.1,"position":[-1536,1632],"id":"164e3f06-c38a-444c-90c2-908d4b1e092d","name":"remove label","webhookId":"ff04b398-6e69-449f-83b8-90e16d3416bc","credentials":{"gmailOAuth2":{"id":"g5jOu8vwcyLtJevm","name":"Gmail account Sapitec"}}},{"parameters":{"operation":"removeLabels","messageId":"={{ $json.id }}","labelIds":["UNREAD"],"path":"1515b081-4b76-47ba-b126-2f683f223d02"},"type":"n8n-nodes-base.gmail","typeVersion":2.1,"position":[-1328,1632],"id":"0c36f7df-48b1-4261-b5dc-84b9c2e5c60a","name":"unread","webhookId":"1515b081-4b76-47ba-b126-2f683f223d02","credentials":{"gmailOAuth2":{"id":"g5jOu8vwcyLtJevm","name":"Gmail account Sapitec"}}},{"parameters":{"operation":"addLabels","messageId":"={{ $json.id }}","labelIds":["Label_1744436849750838610"],"path":"6cf300c8-3bd7-4a63-940a-c63bdc987b01"},"type":"n8n-nodes-base.gmail","typeVersion":2.1,"position":[-880,1648],"id":"346a0a63-e29a-4371-ac96-1367e894956d","name":"sapitec_voiceMessage","webhookId":"6cf300c8-3bd7-4a63-940a-c63bdc987b01","credentials":{"gmailOAuth2":{"id":"g5jOu8vwcyLtJevm","name":"Gmail account Sapitec"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"deebff0e-ae56-48f7-9b4e-dfae9dad2a53","leftValue":"={{ $('_isTest').item.json.test }}","rightValue":"","operator":{"type":"boolean","operation":"false","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-1776,1712],"id":"5278a01b-e13c-4103-ab00-37a6549a0ce1","name":"If3"},{"parameters":{"operation":"update","tableId":"emails","filters":{"conditions":[{"keyName":"id","condition":"eq","keyValue":"={{ $json.id_email }}"}]},"fieldsUi":{"fieldValues":[{"fieldId":"type","fieldValue":"={{ $json.output.type }}"},{"fieldId":"client_raison_sociale","fieldValue":"={{ $json.output.client.raisonSociale }}"},{"fieldId":"client_prenom_nom","fieldValue":"={{ $json.output.client.nomPrenom }}"},{"fieldId":"client_adresse","fieldValue":"={{ $json.output.client.adresse }}"},{"fieldId":"client_code_postal","fieldValue":"={{ $json.output.client.codePostal }}"},{"fieldId":"client_ville","fieldValue":"={{ $json.output.client.ville }}"},{"fieldId":"lese_nom_prenom","fieldValue":"={{ $json.output.lese.nomPrenom }}"},{"fieldId":"lese_adresse","fieldValue":"={{ $json.output.lese.adresse }}"},{"fieldId":"lese_code_postal","fieldValue":"={{ $json.output.lese.codePostal }}"},{"fieldId":"lese_ville","fieldValue":"={{ $json.output.lese.ville }}"},{"fieldId":"lese_tel","fieldValue":"={{ $json.output.lese.tel }}"},{"fieldId":"lese_email","fieldValue":"={{ $json.output.lese.email }}"},{"fieldId":"client_tel","fieldValue":"={{ $json.output.client.tel }}"},{"fieldId":"client_email","fieldValue":"={{ $json.output.client.email }}"},{"fieldId":"titre","fieldValue":"={{ $json.output.titre }}"},{"fieldId":"reference","fieldValue":"={{ $json.output.reference }}"},{"fieldId":"url_ordre_service","fieldValue":"={{ $json.output.url_info }}"},{"fieldId":"url_password","fieldValue":"={{ $json.output.url_password }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[608,112],"id":"2b8b3977-785c-4ba4-8369-9f17e0c2a82f","name":"update_email","credentials":{"supabaseApi":{"id":"c6pA96O6wOcfq8wb","name":"Supabase account"}},"onError":"continueErrorOutput"},{"parameters":{"assignments":{"assignments":[{"id":"d0b8b99d-fd3f-4451-bf7f-6630926fe477","name":"Key","value":"={{ $json.Key }}","type":"string"},{"id":"e43dd72f-ade6-44ff-ac74-33f9a2a53883","name":"Id_bucket","value":"={{ $json.Id }}","type":"string"},{"id":"34228524-abcc-45c5-8faa-3391243f3429","name":"gmail_id","value":"={{ $('Path Builder').item.json.email_id }}","type":"string"},{"id":"5641a1fc-0d58-4b97-95ea-61145c2d20d3","name":"file_name","value":"={{ $('Path Builder').item.json.file_name }}","type":"string"},{"id":"254c0e41-721a-4512-8cce-bca04aeebd2b","name":"file_type","value":"={{ $('Path Builder').item.json.file_type }}","type":"string"},{"id":"1093e1cf-0efc-4937-aaa4-5839794fcb7d","name":"file_path","value":"={{ $('Path Builder').item.json.file_path }}","type":"string"},{"id":"5deee2e6-9e83-40a1-96d6-086ae0237162","name":"uploaded_at","value":"={{ $('Path Builder').item.json.uploaded_at }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-880,640],"id":"a5455e2c-51e1-41b3-b249-243cbaca0a6e","name":"Edit Fields"},{"parameters":{"assignments":{"assignments":[{"id":"a8df2c18-02bf-42ee-9da8-d10dc05dec3f","name":"attachments_count","value":"={{ $('Code').item.json.attachments_count }}","type":"number"}]},"includeOtherFields":true,"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-880,432],"id":"f9b7c883-6456-4f74-bfc6-34c297f86aeb","name":"Edit Fields3"},{"parameters":{"operation":"getAll","tableId":"clients","limit":"=1","filters":{"conditions":[{"keyName":"raison_sociale","condition":"like","keyValue":"={{ $json.client_raison_sociale }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[816,112],"id":"e0f07bc0-43dc-4d93-9710-d3a5766b328b","name":"getClient","alwaysOutputData":true,"credentials":{"supabaseApi":{"id":"c6pA96O6wOcfq8wb","name":"Supabase account"}},"disabled":true,"onError":"continueRegularOutput"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"38c6e327-aa6a-4acb-99fe-a3e703102eb5","leftValue":"={{ $json.file_type }}","rightValue":"application/pdf","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-656,832],"id":"9bfaa207-843f-4eb5-91c2-4bed535448cc","name":"If4"},{"parameters":{"operation":"pdf","options":{"joinPages":false}},"type":"n8n-nodes-base.extractFromFile","typeVersion":1,"position":[80,608],"id":"7af5c6bf-82d2-4f96-94f9-ba633af5c2f3","name":"Extract from File"},{"parameters":{"model":{"__rl":true,"value":"gpt-4.1-mini","mode":"list","cachedResultName":"gpt-4.1-mini"},"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[1200,704],"id":"bcaabc0d-deaa-419f-a41b-b8d4e7f3c989","name":"OpenAI Chat Model1","credentials":{"openAiApi":{"id":"w9SlUWDfkUpRmR78","name":"OpenAi account"}}},{"parameters":{"text":"={{ $json.fullText }}","schemaType":"fromJson","jsonSchemaExample":"{\n\n\t\t\"client_adresse\" : \"12 Rue de la R√©publique\",\n\t\t\"client_code_postal\" : \"69002\",\n\t\t\"client_email\" : \"claire.morel@francia.fr\",\n\t\t\"client_id\" : null,\n\t\t\"client_prenom_nom\" : \"Claire Morel\",\n\t\t\"client_raison_sociale\" : \"FRANCIA SARL\",\n\t\t\"client_tel\" : \"04 72 56 23 89\",\n\t\t\"client_ville\" : \"Lyon\",\n\n\t\t\"lese_adresse\" : \"45 Avenue des Tilleuls\",\n\t\t\"lese_code_postal\" : \"69008\",\n\t\t\"lese_email\" : \"jean.dupont@example.com\",\n\t\t\"lese_info_compl\" : null,\n\t\t\"lese_nom_prenom\" : \"Jean Dupont\",\n\t\t\"lese_tel\" : \"06 78 90 12 34\",\n\t\t\"lese_ville\" : \"Lyon\",\n\n\t\t\"reference\" : \"AX123456\",\n  \t\t\"numDevis\" : \"D25073703\"\n\t}","options":{"systemPromptTemplate":"=tu es un analyseur de PDF hors pair. Tu analyses les pi√®ces jointes en PDF envoy√© par un client (r√©gie, syndic) √† la soci√©t√© Sapitec qui fait des interventions.\n\nTu es capable de rep√©rer qui est le client (syndic, r√©gie, celui qui fait la demande) et chez qui il faut intervenir (l√©s√©, lieu d'intervention) en extrayant les coordonn√©es n√©cessaires de chacun.\n\n**IMPORTANT** Si tu ne trouves pas une information tu n'inventes jamais rien, tu laisses vide.\n\ntu travailles pour la soci√©t√© SAPITEC, le client ou le l√©s√© ne peuvent JAMAIS √™tre SAPITEC, 3 Rue Louis Lachenal, 69740 Genas.\n\ncas d'une COMMANDE  (devis sapitec valid√©) : \n* Parfois tu devras analyser un PDF qui sera le devis de la soci√©t√© SAPITEC, qui a √©t√© envoy√© au client (ent√™te et pied de page sapitec, pr√©sence de \"Genas le :\" puis la date. Dans ce cas seulement tu devras r√©cup√©rer le num√©ro de devis qui est toujours sous la forme D + 8chiffres. Exemple \"D25073703\". Le mettre dans la cl√© \"numDevis\"\n* si c'est une commande, le lese_nom_prenom ne peut en aucun cas √™tre la m√™me personne que le client_prenom_nom.\n * les infos du l√©s√© de l'intervention est en g√©n√©ral pr√©cis√© dans \"Affaire:\""}},"type":"@n8n/n8n-nodes-langchain.informationExtractor","typeVersion":1,"position":[1248,512],"id":"58367012-2153-4d49-85d2-11343d83470b","name":"Information Extractor1"},{"parameters":{"mode":"combine","advanced":true,"mergeByFields":{"values":[{"field1":"gmail_id","field2":"email_id"}]},"options":{}},"type":"n8n-nodes-base.merge","typeVersion":3.1,"position":[-224,704],"id":"a8e51482-8996-4191-abd7-262527619477","name":"Merge3"},{"parameters":{"mode":"combine","advanced":true,"mergeByFields":{"values":[{"field1":"Id_bucket2","field2":"Id_bucket"}]},"options":{}},"type":"n8n-nodes-base.merge","typeVersion":3.1,"position":[1840,512],"id":"24bb8359-1a94-4962-8b38-9c082f961526","name":"Merge4"},{"parameters":{"operation":"update","tableId":"email_attachments","filters":{"conditions":[{"keyName":"id","condition":"eq","keyValue":"={{ $json.id_attachment }}"}]},"fieldsUi":{"fieldValues":[{"fieldId":"infoAttachement","fieldValue":"={{ $json.output }}"},{"fieldId":"gmail_id","fieldValue":"={{ $json.gmail_id }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[2064,512],"id":"df383add-4ff6-47b8-a117-030ba426b972","name":"Supabase","credentials":{"supabaseApi":{"id":"c6pA96O6wOcfq8wb","name":"Supabase account"}}},{"parameters":{"jsCode":"/**\n * Transforme n‚Äôimporte quel nom en cl√© 100 % s√ªre pour Supabase Storage\n * - enl√®ve les accents\n * - remplace les caract√®res interdits par _\n * - condense les doubles _\n */\nfunction toSafeFileName(name = 'file.bin') {\n  return name\n    // 1Ô∏è‚É£ S√©pare les signes diacritiques puis les supprime\n    .normalize('NFD')\n    .replace(/[\\u0300-\\u036f]/g, '')\n\n    // 2Ô∏è‚É£ Remplace tout caract√®re NON pr√©sent dans la whitelist S3/Supa\n    .replace(/[^A-Za-z0-9 !_\\-.()*'&$@=;:+,?]/g, '_')\n\n    // 3Ô∏è‚É£ Condense __ successifs, retire _ en d√©but/fin\n    .replace(/_+/g, '_')\n    .replace(/^_+|_+$/g, '');\n}\n\n// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n// Code Node complet\n// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\nconst bucketName = 'email-attachment';\nconst projectUrl = 'https://drrgcimyszqllymfxqbm.supabase.co';\nconst today = new Date().toISOString().slice(0, 10); // ex. 2025-07-07\n\nreturn $input.all().map(item => {\n  const bin = item.binary?.data;\n  const emailId = item.json.email_id;\n\n  if (!emailId) {\n    throw new Error('email_id manquant dans l‚Äôitem ‚Äì injecte-le avant ce node');\n  }\n  if (!bin) {\n    throw new Error('Pi√®ce jointe absente dans binary.data');\n  }\n\n  const rawFileName = bin.fileName || 'file.bin';\n  const mimeType    = bin.mimeType || 'application/octet-stream';\n  const fileSize    = bin.fileSize ?? Buffer.from(bin.data, 'base64').length;\n\n  // üöÄ Ici la magie :\n  const safeFileName = toSafeFileName(rawFileName);\n  const filePath     = `${today}/${emailId}/${safeFileName}`;\n\n  return {\n    json: {\n      email_id:    emailId,\n      file_name:   rawFileName,\n      file_type:   mimeType,\n      file_size:   fileSize,\n      file_path:   filePath,\n      uploaded_at: new Date().toISOString(),\n\n      // URLs d‚Äôupload direct\n      upload_rest_url: `${projectUrl}/storage/v1/object/${bucketName}/${filePath}`,\n      upload_s3_url:   `${projectUrl}/storage/v1/s3/${bucketName}/${filePath}`,\n    },\n    binary: { data: bin },\n  };\n});"},"name":"Path Builder","type":"n8n-nodes-base.code","position":[-1536,704],"id":"bef852d4-9c04-4bf7-9f08-8169cb0f4342","typeVersion":2},{"parameters":{"assignments":{"assignments":[{"id":"a680c564-36d6-4a60-869d-34af8349f15f","name":"id_attachment","value":"={{ $json.id }}","type":"string"},{"id":"f7aa66b9-6a46-45cf-8694-bc5fc78bf0f9","name":"Id_bucket","value":"={{ $('Edit Fields').item.json.Id_bucket }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[608,432],"id":"eda6cd32-3e3a-4ac5-98ea-ea6148ca2478","name":"Edit Fields5"},{"parameters":{"jsCode":"const MIN_SIZE = 25 * 1024; // 45 Ko en octets\n\n// Fonction utilitaire pour convertir \"229 kB\", \"7.05 kB\", etc. en octets\nfunction parseSize(sizeStr) {\n  const match = sizeStr.match(/^([\\d.]+)\\s*(kB|MB|B)$/i);\n  if (!match) return 0;\n\n  const value = parseFloat(match[1]);\n  const unit = match[2].toLowerCase();\n\n  if (unit === 'kb') return value * 1024;\n  if (unit === 'mb') return value * 1024 * 1024;\n  if (unit === 'b')  return value;\n  return 0;\n}\n\n// Filtrer les items en fonction de leur taille\nconst filtered = $input.all().filter(item => {\n  const sizeStr = item.json.file_size;\n  const bytes = parseSize(sizeStr);\n  return bytes >= MIN_SIZE;\n});\n\nreturn filtered;"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-1328,704],"id":"9631d6ca-31d3-43f2-8b28-5fa773630506","name":"sizeFilter1"},{"parameters":{"jsCode":"return $input.all().map((item, index) => {\n  return {\n    json: {\n      index,\n      fullText: Array.isArray(item.json.text) ? item.json.text.join('\\n') : '',\n      Id_bucket: item.json.Id_bucket,\n      ...item.json\n    }\n  };\n});"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[608,640],"id":"2b8250be-c1e6-4724-b32f-6150078f0453","name":"Code2"},{"parameters":{"assignments":{"assignments":[{"id":"effa1acf-5453-44b1-81ff-6201dc229822","name":"output","value":"={{ $json.output }}","type":"object"},{"id":"0f8b37cf-7199-4b0a-b109-d986aa6755cd","name":"Id_bucket2","value":"={{ $('Merge5').item.json.Id_bucket }}","type":"string"},{"id":"431a1084-4aee-4a6b-ae57-dc9c49d33888","name":"id_attachment","value":"={{ $('Merge5').item.json.id_attachment }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[1632,512],"id":"4efeb393-47a7-4475-bc4c-4a5397f0aa38","name":"Edit Fields4"},{"parameters":{"assignments":{"assignments":[{"id":"55f595c5-bf95-4ba4-a049-3f5bd2800864","name":"Id_bucket","value":"={{ $('Merge3').item.json.Id_bucket }}","type":"string"},{"id":"62051e15-6888-4fce-be6e-d4e8a758d6c5","name":"gmail_id","value":"={{ $('Merge3').item.json.gmail_id }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[1424,832],"id":"a034dc59-8252-4e55-a47d-5159fbb5a22e","name":"Edit Fields6"},{"parameters":{"mode":"combine","fieldsToMatchString":"Id_bucket","options":{}},"type":"n8n-nodes-base.merge","typeVersion":3.1,"position":[816,512],"id":"9f531b8b-4bda-4269-9176-abc09b31d32f","name":"Merge5"},{"parameters":{"mode":"combine","combineBy":"combineByPosition","options":{}},"type":"n8n-nodes-base.merge","typeVersion":3.1,"position":[384,704],"id":"b2be66b3-e184-4b31-97f8-6f5c1e33b462","name":"Merge6"},{"parameters":{"operation":"getAll","tableId":"contacts","limit":1,"filters":{"conditions":[{"keyName":"client_id","condition":"eq","keyValue":"={{ $('getClient').item.json.id }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[1632,112],"id":"e0a0a115-495a-46df-ba71-58597c8df153","name":"getContact","alwaysOutputData":true,"disabled":true,"onError":"continueRegularOutput"},{"parameters":{"operation":"update","tableId":"emails","filters":{"conditions":[{"keyName":"id","condition":"eq","keyValue":"={{ $('update_email').item.json.id }}"}]},"fieldsUi":{"fieldValues":[{"fieldId":"client_id","fieldValue":"={{ $json.id }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[1424,112],"id":"2286f7d5-e128-4acc-9117-ed9f92d9f647","name":"update_clientid","credentials":{"supabaseApi":{"id":"c6pA96O6wOcfq8wb","name":"Supabase account"}},"disabled":true},{"parameters":{"operation":"update","tableId":"emails","filters":{"conditions":[{"keyName":"id","condition":"eq","keyValue":"={{ $('update_email').item.json.id }}"}]},"fieldsUi":{"fieldValues":[{"fieldId":"contact_id","fieldValue":"={{ $json.id }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[1856,112],"id":"99af8ba5-1875-4696-b2de-88e2d608d0f4","name":"update_contactid","credentials":{"supabaseApi":{"id":"c6pA96O6wOcfq8wb","name":"Supabase account"}},"disabled":true},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"6147be21-e3e5-4037-8aaf-898f1d5ae7d8","leftValue":"={{ $json.id }}","rightValue":"","operator":{"type":"string","operation":"notEmpty","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[1120,112],"id":"8f05cf22-50c4-4a53-84ad-3d1934c1946f","name":"If5"},{"parameters":{"operation":"addLabels","messageId":"={{ $json.id }}","labelIds":["Label_1186542609664575387"],"path":"818cc5e6-fd82-4976-af1e-245b23366450"},"type":"n8n-nodes-base.gmail","typeVersion":2.1,"position":[-1328,1840],"id":"d802a737-cd66-4f53-a9ba-05a634d5c105","name":"operaTech_outbox","webhookId":"818cc5e6-fd82-4976-af1e-245b23366450","disabled":true},{"parameters":{"operation":"removeLabels","messageId":"={{ $json.id }}","labelIds":["INBOX"],"path":"53b88e33-6f36-44c1-9720-0eb9aa91b91a"},"type":"n8n-nodes-base.gmail","typeVersion":2.1,"position":[-1536,1840],"id":"3b58bd70-f2b2-44c2-be19-adc3e8858d18","name":"remove label1","webhookId":"53b88e33-6f36-44c1-9720-0eb9aa91b91a","credentials":{"gmailOAuth2":{"id":"g5jOu8vwcyLtJevm","name":"Gmail account Sapitec"}},"disabled":true},{"parameters":{"operation":"toText","sourceProperty":"text","options":{"encoding":"utf8"}},"type":"n8n-nodes-base.convertToFile","typeVersion":1.1,"position":[-1104,1200],"id":"0af749ac-9551-4589-b381-0edfe581e256","name":"Convert to File"},{"parameters":{"options":{"reset":false}},"type":"n8n-nodes-base.splitInBatches","typeVersion":3,"position":[-1760,1104],"id":"5a772b74-b779-49bc-b119-81d2573ec446","name":"Loop Over Items"},{"parameters":{"method":"POST","url":"=https://supabasekong.eurekia-solutions.com/storage/v1/object/email-attachments/{{ $('Code3').item.json.filePath }}","authentication":"genericCredentialType","genericAuthType":"httpBearerAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"  x-upsert","value":"true"}]},"sendBody":true,"contentType":"binaryData","inputDataFieldName":"data","options":{}},"name":"Upload to Storage1","type":"n8n-nodes-base.httpRequest","position":[-880,1200],"id":"dd83390a-b32c-4aea-bed2-49a1e9f998c6","typeVersion":4.2,"credentials":{"httpBearerAuth":{"id":"LcmmlniTWcYXU9cu","name":"Bearer Auth supabase SERVICE KEY"}},"onError":"continueErrorOutput"},{"parameters":{"operation":"get","tableId":"emails","filters":{"conditions":[{"keyName":"gmail_id","keyValue":"={{ $json.id_gmail }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[-1104,1008],"id":"27e17750-7fd6-4cce-b2db-87b0324775d7","name":"Supabase2","credentials":{"supabaseApi":{"id":"c6pA96O6wOcfq8wb","name":"Supabase account"}}},{"parameters":{"assignments":{"assignments":[{"id":"a2f86bc2-2887-4cd3-a623-4bf35c992db2","name":"Key","value":"={{ $json.Key }}","type":"string"},{"id":"4264577f-642a-43d1-8079-dcd77c49c6b7","name":"Id_bucket","value":"={{ $json.Id }}","type":"string"},{"id":"9cbd3984-7a08-48a1-9304-7810911a1327","name":"id_gmail","value":"={{ $('Code3').item.json.id_gmail }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-656,1200],"id":"25b3419e-a7f4-4638-815b-15a0fa839f13","name":"Edit Fields7"},{"parameters":{"assignments":{"assignments":[{"id":"4b6fdf84-ad82-4045-81bc-f03a75512275","name":"Key","value":"={{ $json.Key }}","type":"string"},{"id":"b3f56fea-a23d-4c4d-bef2-83235c5ddff8","name":"Id_bucket","value":"={{ $json.Id_bucket }}","type":"string"},{"id":"78bbface-6f1c-4a92-ad4c-c531ce6e1da3","name":"id_gmail","value":"={{ $json.id_gmail }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-1328,1008],"id":"c7c3e43b-3400-40c3-8c39-6f8d8ba4a59d","name":"Edit Fields8"},{"parameters":{"assignments":{"assignments":[{"id":"1de02bc6-d6cf-429c-8c50-8cc8b1e917b6","name":"text","value":"={{ $json.text }}","type":"string"},{"id":"a03fdb3a-dd20-4bb8-9a58-50c46464f49a","name":"id_gmail","value":"={{ $json.id }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-1536,1200],"id":"e5ee4c6a-6cf1-4a1f-9a13-2a85ad7b43e9","name":"Edit Fields9"},{"parameters":{"jsCode":"// Param√®tres d'entr√©e\nconst emailId = $json.id_gmail || 'unknown_id';\nconst fileName = 'email.txt';\n\n// Cr√©e la date du jour au format YYYY-MM-DD\nconst today = new Date().toISOString().split('T')[0];\n\n// Nettoie le nom de fichier (remplace les caract√®res sp√©ciaux)\nconst safeFileName = fileName.replace(/[\\[\\]#?\\\\]/g, '_');\n\n// Construit le chemin final dans le bucket\nconst filePath = `${today}/${emailId}/${safeFileName}`;\n\n// Ajoute le champ filePath √† l'item\nreturn [\n  {\n    json: {\n      ...$json,\n      filePath, // ‚Üê utilisable dans ton node d'upload\n    },\n    binary: $binary, // Si tu as d√©j√† un fichier binaire attach√©\n  }\n];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-1328,1200],"id":"c10e9d3a-b486-4f83-9ae3-1c3506b4e479","name":"Code3"},{"parameters":{"jsCode":"return $input.all().map(item => {\n  const fullKey = item.json.Key || '';\n  const cleanKey = fullKey.replace(/^email-attachments\\//, '');\n\n  return {\n    json: {\n      ...item.json,\n      Key: cleanKey\n    }\n  };\n});"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-1536,1008],"id":"a3166efa-1d8b-421e-86d1-c8b4f558df13","name":"Code4"},{"parameters":{"tableId":"email_attachments","fieldsUi":{"fieldValues":[{"fieldId":"file_name","fieldValue":"email.txt"},{"fieldId":"file_path","fieldValue":"={{ $('Edit Fields8').item.json.Key }}"},{"fieldId":"email_id","fieldValue":"={{ $json.id }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[-880,1008],"id":"1e090890-f56a-4b21-8ef9-97bd488a3fd5","name":"Supabase1","credentials":{"supabaseApi":{"id":"c6pA96O6wOcfq8wb","name":"Supabase account"}}},{"parameters":{},"type":"n8n-nodes-base.manualTrigger","typeVersion":1,"position":[-3088,1104],"id":"3a7ff8f6-0460-4066-83c0-1ece04994fab","name":"When clicking ‚ÄòTest workflow‚Äô"},{"parameters":{"operation":"addLabels","messageId":"={{ $json.id }}","labelIds":["Label_5880747059839672705"],"path":"8fb9ba24-9103-4dfc-8949-923f815d6ced"},"type":"n8n-nodes-base.gmail","typeVersion":2.1,"position":[-880,1904],"id":"71c47180-3c47-4b61-9387-34a67e825666","name":"sapitec_processed","webhookId":"8fb9ba24-9103-4dfc-8949-923f815d6ced","credentials":{"gmailOAuth2":{"id":"g5jOu8vwcyLtJevm","name":"Gmail account Sapitec"}}},{"parameters":{"operation":"update","tableId":"emails","filters":{"conditions":[{"keyName":"gmail_id","condition":"eq","keyValue":"={{ $json.id }}"}]},"fieldsUi":{"fieldValues":[{"fieldId":"is_complete","fieldValue":"True"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[-656,1600],"id":"78844331-c1ea-49c4-9641-ed601d1be1e4","name":"is_compete True","credentials":{"supabaseApi":{"id":"c6pA96O6wOcfq8wb","name":"Supabase account"}}},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{ $('testFrom').item.json.snippet }}","rightValue":"^-- RAPPEL --","operator":{"type":"string","operation":"regex"},"id":"eba25079-2e15-432b-9f9d-252549d72028"}],"combinator":"and"}},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"d79cc8c2-b04b-44a2-8d0e-c2534ae74428","leftValue":"={{ $('testFrom').item.json.From }}","rightValue":"3CX","operator":{"type":"string","operation":"contains"}}],"combinator":"and"}}]},"options":{"fallbackOutput":"extra"}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[-1104,1632],"id":"68cbce31-ec45-4dfa-9f77-41d668d0ac6e","name":"Switch"},{"parameters":{"operation":"addLabels","messageId":"={{ $json.id }}","labelIds":["Label_2372306989342579751"],"path":"16b12533-18ad-4f59-a84c-78b7a3882c2c"},"type":"n8n-nodes-base.gmail","typeVersion":2.1,"position":[-880,1440],"id":"b9550bb8-a8bb-4902-bcc1-3d296bd36b60","name":"sapitec_rappel","webhookId":"16b12533-18ad-4f59-a84c-78b7a3882c2c","credentials":{"gmailOAuth2":{"id":"g5jOu8vwcyLtJevm","name":"Gmail account Sapitec"}}},{"parameters":{"jsCode":"for (const item of $input.all()) {\n  const html = item.json.body ?? '';\n  // Enl√®ve <img ...> (auto-ferm√©e ou non) et un √©ventuel </img>\n  item.json.body = html.replace(\n    /<img\\b[^>]*?(?:\\/>|>)(?:\\s*<\\/img>)?/gi,\n    ''\n  );\n}\nreturn $input.all();"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-1328,112],"id":"fd7222f3-1c82-4a9b-9ce9-acc68fe92504","name":"regex img"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"13a1751e-c5a5-4c83-9306-51f95d4e0fe9","leftValue":"={{ $json.fullText.replace(/\\s/g, '') !== '' }}","rightValue":"=","operator":{"type":"boolean","operation":"true","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[1024,512],"id":"edf366c7-f0a3-416c-9f2e-39afbaa82eaa","name":"If1"},{"parameters":{"errorMessage":"identifiaction sapitec gmail sur VPS2"},"type":"n8n-nodes-base.stopAndError","typeVersion":1,"position":[-1920,1488],"id":"81388313-b4e4-4526-a5b9-221bd2bf27c9","name":"Stop and Error"}],"connections":{"Upload to Storage":{"main":[[{"node":"Edit Fields","type":"main","index":0}]]},"Insert Attachment Row":{"main":[[{"node":"Edit Fields5","type":"main","index":0}]]},"split attachments":{"main":[[{"node":"Path Builder","type":"main","index":0}]]},"Insert Email":{"main":[[{"node":"If","type":"main","index":0},{"node":"Edit Fields3","type":"main","index":0}]]},"Code":{"main":[[{"node":"regex img","type":"main","index":0}]]},"Code1":{"main":[[{"node":"Merge","type":"main","index":0}]]},"Merge":{"main":[[{"node":"Insert Attachment Row","type":"main","index":0},{"node":"Merge3","type":"main","index":0}]]},"OpenAI Chat Model":{"ai_languageModel":[[{"node":"cat√©goriser email","type":"ai_languageModel","index":0}]]},"If":{"main":[[{"node":"Edit Fields1","type":"main","index":0}],[{"node":"Edit Fields2","type":"main","index":0}]]},"Edit Fields1":{"main":[[{"node":"Split Out","type":"main","index":0}]]},"Edit Fields2":{"main":[[{"node":"Split Out","type":"main","index":0}]]},"Split Out":{"main":[[{"node":"prompt","type":"main","index":0}]]},"prompt":{"main":[[{"node":"cat√©goriser email","type":"main","index":0},{"node":"Merge1","type":"main","index":1}]]},"cat√©goriser email":{"main":[[{"node":"Merge1","type":"main","index":0}]]},"Schedule Trigger":{"main":[[{"node":"_isTest","type":"main","index":0}]]},"getEmais":{"main":[[{"node":"testFrom","type":"main","index":0}],[{"node":"Stop and Error","type":"main","index":0}]]},"_isTest":{"main":[[{"node":"If2","type":"main","index":0}]]},"If2":{"main":[[{"node":"getEmais","type":"main","index":0}],[{"node":"getEmail TEST","type":"main","index":0}]]},"getEmail TEST":{"main":[[{"node":"testFrom","type":"main","index":0}]]},"testFrom":{"main":[[{"node":"remove label","type":"main","index":0}],[{"node":"getEmailAndAttach","type":"main","index":0}]]},"getEmailAndAttach":{"main":[[{"node":"split attachments","type":"main","index":0},{"node":"If3","type":"main","index":0},{"node":"Loop Over Items","type":"main","index":0},{"node":"Code","type":"main","index":0}]]},"Merge1":{"main":[[{"node":"update_email","type":"main","index":0}]]},"remove label":{"main":[[{"node":"unread","type":"main","index":0}]]},"unread":{"main":[[{"node":"Switch","type":"main","index":0}]]},"If3":{"main":[[{"node":"remove label","type":"main","index":0}],[{"node":"remove label1","type":"main","index":0}]]},"Edit Fields":{"main":[[{"node":"Merge","type":"main","index":1}]]},"Edit Fields3":{"main":[[{"node":"Code1","type":"main","index":0}]]},"getClient":{"main":[[{"node":"If5","type":"main","index":0}]]},"Extract from File":{"main":[[{"node":"Merge6","type":"main","index":0}]]},"OpenAI Chat Model1":{"ai_languageModel":[[{"node":"Information Extractor1","type":"ai_languageModel","index":0}]]},"If4":{"main":[[{"node":"Merge3","type":"main","index":1}]]},"Merge3":{"main":[[{"node":"Extract from File","type":"main","index":0},{"node":"Merge6","type":"main","index":1}]]},"Information Extractor1":{"main":[[{"node":"Edit Fields4","type":"main","index":0}]]},"Merge4":{"main":[[{"node":"Supabase","type":"main","index":0}]]},"Path Builder":{"main":[[{"node":"sizeFilter1","type":"main","index":0}]]},"Edit Fields5":{"main":[[{"node":"Merge5","type":"main","index":0}]]},"sizeFilter1":{"main":[[{"node":"If4","type":"main","index":0},{"node":"Upload to Storage","type":"main","index":0}]]},"Code2":{"main":[[{"node":"Merge5","type":"main","index":1}]]},"Edit Fields4":{"main":[[{"node":"Merge4","type":"main","index":0}]]},"Edit Fields6":{"main":[[{"node":"Merge4","type":"main","index":1}]]},"Merge5":{"main":[[{"node":"If1","type":"main","index":0}]]},"Merge6":{"main":[[{"node":"Edit Fields6","type":"main","index":0},{"node":"Code2","type":"main","index":0}]]},"getContact":{"main":[[{"node":"update_contactid","type":"main","index":0}]]},"update_email":{"main":[[{"node":"getClient","type":"main","index":0}]]},"update_clientid":{"main":[[{"node":"getContact","type":"main","index":0}]]},"If5":{"main":[[{"node":"update_clientid","type":"main","index":0}]]},"remove label1":{"main":[[{"node":"operaTech_outbox","type":"main","index":0}]]},"operaTech_outbox":{"main":[[{"node":"is_compete True","type":"main","index":0}]]},"sapitec_voiceMessage":{"main":[[{"node":"is_compete True","type":"main","index":0}]]},"Convert to File":{"main":[[{"node":"Upload to Storage1","type":"main","index":0}]]},"Loop Over Items":{"main":[[{"node":"Code4","type":"main","index":0}],[{"node":"Edit Fields9","type":"main","index":0}]]},"Upload to Storage1":{"main":[[{"node":"Edit Fields7","type":"main","index":0}]]},"Supabase2":{"main":[[{"node":"Supabase1","type":"main","index":0}]]},"Edit Fields7":{"main":[[{"node":"Loop Over Items","type":"main","index":0}]]},"Edit Fields8":{"main":[[{"node":"Supabase2","type":"main","index":0}]]},"Edit Fields9":{"main":[[{"node":"Code3","type":"main","index":0}]]},"Code3":{"main":[[{"node":"Convert to File","type":"main","index":0}]]},"Code4":{"main":[[{"node":"Edit Fields8","type":"main","index":0}]]},"When clicking ‚ÄòTest workflow‚Äô":{"main":[[{"node":"_isTest","type":"main","index":0}]]},"sapitec_processed":{"main":[[{"node":"is_compete True","type":"main","index":0}]]},"Switch":{"main":[[{"node":"sapitec_rappel","type":"main","index":0}],[{"node":"sapitec_voiceMessage","type":"main","index":0}],[{"node":"sapitec_processed","type":"main","index":0}]]},"sapitec_rappel":{"main":[[{"node":"is_compete True","type":"main","index":0}]]},"regex img":{"main":[[{"node":"Insert Email","type":"main","index":0}]]},"If1":{"main":[[{"node":"Information Extractor1","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","callerPolicy":"workflowsFromSameOwner","errorWorkflow":"4xKLB9RPfrowY9h4"},"staticData":null,"meta":null,"pinData":{},"versionId":"5f7f02cc-de17-4045-8d58-38d7579fa347","triggerCount":0,"shared":[{"createdAt":"2025-10-01T14:53:52.660Z","updatedAt":"2025-10-01T14:53:52.660Z","role":"workflow:owner","workflowId":"FvKy9e0sari5gT9p","projectId":"3csiRTB7Dv0MNPzt"}],"tags":[]}