{"createdAt":"2025-11-03T13:24:14.841Z","updatedAt":"2025-11-10T16:48:17.000Z","id":"lYyEBi0T5sTxgMW7","name":"sapitec_retreive-emails-outlook","active":true,"isArchived":false,"nodes":[{"parameters":{"tableId":"emails","fieldsUi":{"fieldValues":[{"fieldId":"gmail_id","fieldValue":"={{ $json.internetMessageId}}"},{"fieldId":"subject","fieldValue":"={{ $json.subject }}"},{"fieldId":"content","fieldValue":"={{ $json.bodyText }}"},{"fieldId":"email_date","fieldValue":"={{ $json.dateEmail }}"},{"fieldId":"from_email","fieldValue":"={{ $json.from }}"},{"fieldId":"to_email","fieldValue":"={{ (() => { \n  const raw = $json.to ;\n  if (!raw) return null; // si vide/undefined -> null\n  const str = Array.isArray(raw) ? raw[0] : raw;\n  return (str.match(/<([^>]+)>/)?.[1] \n       || str.match(/[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\\.[A-Za-z]{2,}/)?.[0] \n       || null);\n})() }}"},{"fieldId":"z_isOutlook","fieldValue":"true"},{"fieldId":"contentHTML","fieldValue":"={{ $json.body }}"},{"fieldId":"z_isTest","fieldValue":"={{ $json.isTest }}"},{"fieldId":"idGraph","fieldValue":"={{ $json.email_id }}"},{"fieldId":"n8n_execution_id","fieldValue":"={{ $json.n8n_execution_id }}"}]}},"id":"c0b2e711-e033-48ad-9ab1-3fd82d1970ec","name":"Insert Email","type":"n8n-nodes-base.supabase","typeVersion":1,"position":[304,32],"alwaysOutputData":true,"credentials":{"supabaseApi":{"id":"c6pA96O6wOcfq8wb","name":"Supabase account"}}},{"parameters":{"method":"POST","url":"=https://supabasekong.eurekia-solutions.com/storage/v1/object/email-attachments/{{ $json.file_path }}","authentication":"genericCredentialType","genericAuthType":"httpBearerAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"  x-upsert","value":"true"}]},"sendBody":true,"contentType":"binaryData","inputDataFieldName":"data","options":{}},"name":"Upload to Storage","type":"n8n-nodes-base.httpRequest","position":[160,1120],"id":"20cb1809-fd21-4e66-bf81-170bd7a423f5","typeVersion":4.2,"credentials":{"httpBearerAuth":{"id":"LcmmlniTWcYXU9cu","name":"Bearer Auth supabase SERVICE KEY"}},"onError":"continueErrorOutput"},{"parameters":{"tableId":"email_attachments","fieldsUi":{"fieldValues":[{"fieldId":"email_id","fieldValue":"={{ $json.email_id }}"},{"fieldId":"file_name","fieldValue":"={{ $json.file_name }}"},{"fieldId":"file_path","fieldValue":"={{ $json.file_path }}"},{"fieldId":"file_type","fieldValue":"={{ $json.file_type }}"}]}},"name":"Insert Attachment Row","type":"n8n-nodes-base.supabase","position":[2064,928],"id":"50056d79-5278-44bf-b81a-cf29a397cca4","typeVersion":1,"credentials":{"supabaseApi":{"id":"c6pA96O6wOcfq8wb","name":"Supabase account"}}},{"parameters":{"jsCode":"const output = [];\n\nfor (const item of $input.all()) {\n\n  const emailId = (item.json.internetMessageId || '')\n  .replace(/^<|>$/g, '')  // retire les chevrons d√©but/fin\n  .trim();\n\n  //const emailId = item.json.id;\n  // PJ binaires\n  if (item.binary && Object.keys(item.binary).length > 0) {\n    for (const [key, binaryData] of Object.entries(item.binary)) {\n      output.push({\n        json: {\n          email_id: emailId,\n          attachmentName: binaryData.fileName || key,\n          contentType: binaryData.mimeType || 'unknown',\n        },\n        binary: {\n          data: binaryData\n        }\n      });\n    }\n  }\n\n  // PJ dans json.attachments (si applicable)\n  else if (Array.isArray(item.json.attachments)) {\n    for (const attachment of item.json.attachments) {\n      output.push({\n        json: {\n          gmail_id: emailId,\n          attachmentId: attachment.attachmentId,\n          filename: attachment.filename,\n          mimeType: attachment.mimeType,\n          size: attachment.size\n        }\n      });\n    }\n  }\n}\n\nreturn output;"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-528,1200],"id":"9246f37a-0f04-4f62-9854-750e516dfdac","name":"split attachments"},{"parameters":{"jsCode":"const output = [];\n\nconst seen = new Set();\n\nfor (const item of $input.all()) {\n  const emailId = item.json.id;\n  const gmailId = item.json.gmail_id;\n\n  if (!emailId || !gmailId || seen.has(gmailId)) {\n    continue;\n  }\n\n  seen.add(gmailId);\n\n  output.push({\n    json: {\n      email_id: emailId,\n      gmail_id: gmailId\n    }\n  });\n}\n\nreturn output;"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[1024,928],"id":"b27dde00-666d-48db-a1ba-c78ba758bc9b","name":"Code1","onError":"continueErrorOutput"},{"parameters":{"mode":"combine","fieldsToMatchString":"gmail_id","options":{}},"type":"n8n-nodes-base.merge","typeVersion":3.1,"position":[1232,1008],"id":"64ab2b25-87fe-4328-8883-1a2ad4e47e6d","name":"Merge"},{"parameters":{"model":{"__rl":true,"value":"gpt-4.1-mini","mode":"list","cachedResultName":"gpt-4.1-mini"},"options":{"temperature":0.2}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[992,144],"id":"4fe2eb7d-09a3-4abc-ba4c-903d9a6e9fbe","name":"OpenAI Chat Model","credentials":{"openAiApi":{"id":"w9SlUWDfkUpRmR78","name":"OpenAi account"}}},{"parameters":{"assignments":{"assignments":[{"id":"9a185dc7-4970-4f44-bc2f-cf899a7882b6","name":"prompt","value":"={{ $json.content }}","type":"string"},{"id":"4afbab65-2fb1-4b71-bf65-faee9c1e5db9","name":"id_email","value":"={{ $json.id }}","type":"string"},{"id":"89707c29-f120-484d-a969-7681182ffbfb","name":"id_gmail","value":"={{ $('nettoyer html').item.json.email_id }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[688,32],"id":"553fc15d-8f23-4cf0-8876-4d29edd919f3","name":"prompt"},{"parameters":{"mode":"combine","combineBy":"combineByPosition","options":{}},"type":"n8n-nodes-base.merge","typeVersion":3.1,"position":[1296,32],"id":"e8c95b6c-a5bc-42ca-b4e0-3ae6b9b7e353","name":"Merge1"},{"parameters":{"text":"=Voici le texte e-mail √† analyser et cat√©goriser : {{ $json.prompt }}","schemaType":"fromJson","jsonSchemaExample":"{\n  \"type\": \"suivi\",\n  \"titre\": \"Absence de devis joint\",\n  \"objet\": \"Demande de renvoi du devis r√©actualis√© pour ESPACE EMERAUDE BAT C/D\",\n  \"url_info\": \"https://...\",\n  \"url_password\": \"2354\",\n  \"reference\": \"0197\",\n  \"client\": {\n    \"raisonSociale\": \"SOGELEM\",\n    \"nomPrenom\": \"Bryan Briard\",\n    \"adresse\": \"12, Cours Emile Zola\",\n    \"codePostal\": \"69100\",\n    \"ville\": \"Villeurbanne\",\n    \"tel\": \"04 72 98 25 21\",\n    \"email\": \"bryan.briard@sogelem.fr\"\n  },\n  \"lese\": {\n    \"nomPrenom\": \"Gaelle Jos\",\n    \"adresse\": \"Immeuble les Fleurs\\r4rue de la paix\",\n    \"codePostal\": \"75008\",\n    \"ville\": \"Paris\",\n    \"tel\": \"04 72 98 25 21\",\n    \"email\": \"gaelle.jos@sogelem.fr\"\n  }\n}","options":{"systemPromptTemplate":"=Vous √™tes l'assistant d‚Äôanalyse d‚Äôe-mails fran√ßais de la soci√©t√© SAPITEC qui re√ßoit des emails de ses clients (R√©gies, Syndics en majorit√©) parlant d'intervention √† faire dans des r√©sidences chez des particuliers (le l√©s√©), ou d'avis de paiement/r√©glement/virements.\n\nLes emails analys√©s peuvent √™tre des emails tranf√©r√©s en interne : il faut ignorer les noms, coordonn√©es et adresses emails des personnes semblant travailler chez SAPITEC. \n\nVotre t√¢che est purement extractive : ne gardez que les informations pr√©sentes explicitement dans l‚Äôe-mail.  \nIgnorez les noms, coordonn√©es et adresses emails des personnes travaillant chez SAPITEC.  \n\nChamps √† produire :\n- Type : <suivi | demande | commande | paiement | autre> (obligatoire, jamais vide)  \n- titre : r√©sum√© court de l‚Äôemail (jamais vide)\n\nurl\n - parfois une url est indique pour un compl√©ment d'information, t√©l√©charger une commande ou d√©poser un devis : √† mettre dans url_info\n - il arrive que l'url soit fournie avec un mot de passe qui permet d'acc√©der au site de la r√©gie, √† renseigner dans url_password\n\n- Client : nom du client, eng√©nral celui qui √©crit l'email et donne les instructions (ou vide si non trouv√©)\n\n- Contact client : en g√©n√©ral celui qui signe l'email\n\n- Details : r√©sum√© concis en reprenant les mots originaux quand possible (ou vide)  \n\n- adresse : \n\n  ‚Ä¢ Num√©ro de voie + nom de voie  \n  ‚Ä¢ Ne jamais inclure le code postal ni la ville  \n- code postal : 5 chiffres si pr√©sent  \n- ville : mot(s) qui suivent imm√©diatement le code postal  \n\nLe l√©s√© :\n\nParfois le nom du l√©s√© n'est pas stipul√© mais l'adresse l'est, souvent avec le nom de l'immeuble ou de la r√©sidence dans ces cas : bien remplir les informations l√©s√© sans stipuler le nom pr√©nom juste.\n\n - Adresse l√©s√© : Peut contenir ‚Äúimmeuble‚Äù, ‚Äúr√©sidence‚Äù, ‚Äúcopropri√©t√©‚Äù, ‚Äúb√¢timent‚Äù si pr√©sent. si tu trouves le nom associ√© le mettre avant l'adresse. Exemple \"Le Clos Fleuri - 29 rue Pierre Brunier\"\n - nom pr√©nom : peut √™tre d√©fini comme le \"contact sur place\" ou \"le membre de la copropri√©t√©\" ou \"le locataire\" ou toute appellation qui fait penser que c'est la personne chez qui il faut intervenir, quand son nom est pr√©cis√©.\n\nCat√©gorisation du champ Type :\n- suivi : relance, question, √©change d√©j√† en cours  \n- demande : premi√®re demande de prix (souvent via un lien ou formulaire)  \n- commande : accord explicite suite √† un devis  \n- autre : paiements, communications internes, hors p√©rim√®tre  \n\nR√®gles imp√©ratives :\n- Le champ Type est toujours obligatoire  \n- Si aucune cat√©gorie ne correspond ‚Üí √©crire ¬´ autre ¬ª  \n- Si une information n‚Äôest pas clairement pr√©sente ‚Üí laisser vide  \n- Ne pas √©crire ‚ÄúN/A‚Äù, ‚Äúexemple‚Äù ou une valeur fictive  \n- Ne jamais mettre ‚ÄúSAPITEC‚Äù comme client\n\nFormat de sortie JSON comme indiqu√© dans l'exemple.\n** IMPORTANT ** renseigner toutes les cl√©s attendues, par exemple si nomPrenom du l√©s√© est vide le mettre dans le json et mettre vide (\"\")\n\n## Exemples de format attendu (illustratifs uniquement) :\n\nEntr√©e :\n¬´ Sauf erreur de notre part, nous n‚Äôavons pas eu de confirmation pour la demande suivante : ¬ª  \nSortie :\nType: suivi  \ntitre: Relance client affaire xxx  \n\nEntr√©e :\n¬´ Peux tu reprendre rendez-vous avec‚Ä¶ ¬ª  \nSortie :\nType: suivi  \ntitre: Suivi de RDV affaire xxx  \n\nEntr√©e :\n¬´ Veuillez prendre connaissance de notre envoi via ce lien : https://formulaire-devis.example.com ¬ª  \nSortie :\nType: demande  \ntitre: Demande de devis affaire xxx  \n\nEntr√©e :\n¬´ Nous confirmons notre commande pour le devis #1234. ¬ª  \nSortie :\nType: commande  \ntitre: Confirmation de commande pour le devis #1234  \n\nEntr√©e :\n\" Bonjour\nJe vous prie de trouver ci-joint le bordereau de factures pour le virement que je vous √©ffectue\nce jour\"\nSortie :\nType: paiement  \ntitre: Avis de r√®glement pour factures ... "}},"type":"@n8n/n8n-nodes-langchain.informationExtractor","typeVersion":1,"position":[1056,-96],"id":"fd0f48d5-375f-42b2-9813-dd0409189f68","name":"cat√©goriser email","onError":"continueErrorOutput"},{"parameters":{"rule":{"interval":[{"field":"minutes"}]}},"type":"n8n-nodes-base.scheduleTrigger","typeVersion":1.2,"position":[-4000,1312],"id":"1eb68a58-4e37-4748-8efd-178f0b836d6a","name":"Schedule Trigger"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"b7378f2a-cc8c-4744-9406-0b2a92b166ce","leftValue":"={{ $json.from.emailAddress.address }}","rightValue":"3CX","operator":{"type":"string","operation":"contains"}},{"id":"74b601d5-4f37-48d7-9833-f68391725a8f","leftValue":"={{ $json.bodyPreview }}","rightValue":"=^-- RAPPEL --","operator":{"type":"string","operation":"regex"}}],"combinator":"or"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-1824,1072],"id":"478547e8-9f3f-4e0a-8c0a-f1c318c8d96e","name":"testFrom"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"ebb11565-64cb-4fda-a8ce-65dbede92410","leftValue":"={{ $json.test }}","rightValue":"","operator":{"type":"boolean","operation":"false","singleValue":true}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-3504,1152],"id":"55a5dc98-527f-45b6-b437-46ac7c5e6d03","name":"If2"},{"parameters":{"operation":"get","messageId":"={{ $json.id }}","simple":false,"options":{"downloadAttachments":true}},"type":"n8n-nodes-base.gmail","typeVersion":2.1,"position":[-2208,1824],"id":"7ff26852-2e30-4dcf-ba97-27f7c2f1aa65","name":"getEmailAndAttach","webhookId":"6ada010a-528b-4ab5-a236-8fa0c877fad2","credentials":{"gmailOAuth2":{"id":"g5jOu8vwcyLtJevm","name":"Gmail account Sapitec"}}},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"loose","version":2},"conditions":[{"id":"deebff0e-ae56-48f7-9b4e-dfae9dad2a53","leftValue":"={{ $json.test }}","rightValue":"","operator":{"type":"boolean","operation":"false","singleValue":true}}],"combinator":"and"},"looseTypeValidation":true,"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[-256,2720],"id":"63edda5e-c18c-43f3-b93d-a65539c740c6","name":"If3"},{"parameters":{"operation":"update","tableId":"emails","filters":{"conditions":[{"keyName":"id","condition":"eq","keyValue":"={{ $json.id_email }}"}]},"fieldsUi":{"fieldValues":[{"fieldId":"type","fieldValue":"={{ $json.output.type }}"},{"fieldId":"client_raison_sociale","fieldValue":"={{ $json.output.client.raisonSociale }}"},{"fieldId":"client_prenom_nom","fieldValue":"={{ $json.output.client.nomPrenom }}"},{"fieldId":"client_adresse","fieldValue":"={{ $json.output.client.adresse }}"},{"fieldId":"client_code_postal","fieldValue":"={{ $json.output.client.codePostal }}"},{"fieldId":"client_ville","fieldValue":"={{ $json.output.client.ville }}"},{"fieldId":"lese_nom_prenom","fieldValue":"={{ $json.output.lese.nomPrenom }}"},{"fieldId":"lese_adresse","fieldValue":"={{ $json.output.lese.adresse }}"},{"fieldId":"lese_code_postal","fieldValue":"={{ $json.output.lese.codePostal }}"},{"fieldId":"lese_ville","fieldValue":"={{ $json.output.lese.ville }}"},{"fieldId":"lese_tel","fieldValue":"={{ $json.output.lese.tel }}"},{"fieldId":"lese_email","fieldValue":"={{ $json.output.lese.email }}"},{"fieldId":"client_tel","fieldValue":"={{ $json.output.client.tel }}"},{"fieldId":"client_email","fieldValue":"={{ $json.output.client.email }}"},{"fieldId":"titre","fieldValue":"={{ $json.output.titre }}"},{"fieldId":"reference","fieldValue":"={{ $json.output.reference }}"},{"fieldId":"url_ordre_service","fieldValue":"={{ $json.output.url_info }}"},{"fieldId":"url_password","fieldValue":"={{ $json.output.url_password }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[1600,32],"id":"e750b51a-4275-4cd2-ae2f-c2e90a287ab7","name":"update_email","credentials":{"supabaseApi":{"id":"c6pA96O6wOcfq8wb","name":"Supabase account"}},"onError":"continueErrorOutput"},{"parameters":{"assignments":{"assignments":[{"id":"d0b8b99d-fd3f-4451-bf7f-6630926fe477","name":"Key","value":"={{ $json.Key }}","type":"string"},{"id":"e43dd72f-ade6-44ff-ac74-33f9a2a53883","name":"Id_bucket","value":"={{ $json.Id }}","type":"string"},{"id":"34228524-abcc-45c5-8faa-3391243f3429","name":"gmail_id","value":"={{ $('Path Builder').item.json.email_id }}","type":"string"},{"id":"5641a1fc-0d58-4b97-95ea-61145c2d20d3","name":"file_name","value":"={{ $('Path Builder').item.json.file_name }}","type":"string"},{"id":"254c0e41-721a-4512-8cce-bca04aeebd2b","name":"file_type","value":"={{ $('Path Builder').item.json.file_type }}","type":"string"},{"id":"1093e1cf-0efc-4937-aaa4-5839794fcb7d","name":"file_path","value":"={{ $('Path Builder').item.json.file_path }}","type":"string"},{"id":"5deee2e6-9e83-40a1-96d6-086ae0237162","name":"uploaded_at","value":"={{ $('Path Builder').item.json.uploaded_at }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[432,1088],"id":"0e017f6c-ca0f-4774-8f8d-067e65c75f69","name":"Edit Fields"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"38c6e327-aa6a-4acb-99fe-a3e703102eb5","leftValue":"={{ $json.file_type }}","rightValue":"application/pdf","operator":{"type":"string","operation":"equals","name":"filter.operator.equals"}},{"id":"53711c5c-a896-4382-a449-bbbb81f0cc31","leftValue":"={{ $json.file_name }}","rightValue":"pdf","operator":{"type":"string","operation":"endsWith"}},{"id":"9eb9bf17-61a8-42b5-8aec-a0c75f87e176","leftValue":"={{ $json.file_name }}","rightValue":"PDF","operator":{"type":"string","operation":"endsWith"}}],"combinator":"or"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[672,1376],"id":"1aec52d1-074b-4088-911b-ba02d2794b8b","name":"If4"},{"parameters":{"operation":"pdf","options":{"joinPages":false}},"type":"n8n-nodes-base.extractFromFile","typeVersion":1,"position":[1776,1056],"id":"74204d73-d465-428a-a3ef-a411aa88ccf8","name":"Extract from File","onError":"continueErrorOutput"},{"parameters":{"model":{"__rl":true,"value":"gpt-4.1-mini","mode":"list","cachedResultName":"gpt-4.1-mini"},"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[3600,1136],"id":"8ba4623e-0202-4f74-be36-e8730b5e1070","name":"OpenAI Chat Model1","credentials":{"openAiApi":{"id":"w9SlUWDfkUpRmR78","name":"OpenAi account"}}},{"parameters":{"mode":"combine","advanced":true,"mergeByFields":{"values":[{"field1":"gmail_id","field2":"email_id"}]},"options":{}},"type":"n8n-nodes-base.merge","typeVersion":3.1,"position":[1456,1200],"id":"92271d6e-379d-40d5-b1bf-56b493a54e5a","name":"Merge3"},{"parameters":{"mode":"combine","advanced":true,"mergeByFields":{"values":[{"field1":"Id_bucket2","field2":"Id_bucket"}]},"options":{}},"type":"n8n-nodes-base.merge","typeVersion":3.1,"position":[5696,992],"id":"f46c5d49-69b4-4eee-a348-47b46fc273f5","name":"Merge4"},{"parameters":{"operation":"update","tableId":"email_attachments","filters":{"conditions":[{"keyName":"id","condition":"eq","keyValue":"={{ $json.id_attachment }}"}]},"fieldsUi":{"fieldValues":[{"fieldId":"infoAttachement","fieldValue":"={{ $json.output }}"},{"fieldId":"gmail_id","fieldValue":"={{ $json.gmail_id }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[5920,992],"id":"249637a5-428a-4c77-9b79-eecf07653ea2","name":"Supabase","credentials":{"supabaseApi":{"id":"c6pA96O6wOcfq8wb","name":"Supabase account"}}},{"parameters":{"jsCode":"/**\n * Transforme n‚Äôimporte quel nom en cl√© 100 % s√ªre pour Supabase Storage\n * - enl√®ve les accents\n * - remplace les caract√®res interdits par _\n * - condense les doubles _\n */\nfunction toSafeFileName(name = 'file.bin') {\n  return name\n    // 1Ô∏è‚É£ S√©pare les signes diacritiques puis les supprime\n    .normalize('NFD')\n    .replace(/[\\u0300-\\u036f]/g, '')\n\n    // 2Ô∏è‚É£ Remplace tout caract√®re NON pr√©sent dans la whitelist S3/Supa\n    .replace(/[^A-Za-z0-9 !_\\-.()*'&$@=;:+,?]/g, '_')\n\n    // 3Ô∏è‚É£ Condense __ successifs, retire _ en d√©but/fin\n    .replace(/_+/g, '_')\n    .replace(/^_+|_+$/g, '');\n}\n\n// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\n// Code Node complet\n// ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ\nconst bucketName = 'email-attachment';\nconst projectUrl = 'https://drrgcimyszqllymfxqbm.supabase.co';\nconst today = new Date().toISOString().slice(0, 10); // ex. 2025-07-07\n\nreturn $input.all().map(item => {\n  const bin = item.binary?.data;\n  const emailId = item.json.email_id;\n\n  if (!emailId) {\n    throw new Error('email_id manquant dans l‚Äôitem ‚Äì injecte-le avant ce node');\n  }\n  if (!bin) {\n    throw new Error('Pi√®ce jointe absente dans binary.data');\n  }\n\n  const rawFileName = bin.fileName || 'file.bin';\n  const mimeType    = bin.mimeType || 'application/octet-stream';\n  const fileSize    = bin.fileSize ?? Buffer.from(bin.data, 'base64').length;\n\n  // üöÄ Ici la magie :\n  const safeFileName = toSafeFileName(rawFileName);\n  const filePath     = `${today}/${emailId}/${safeFileName}`;\n\n  return {\n    json: {\n      email_id:    emailId,\n      file_name:   rawFileName,\n      file_type:   mimeType,\n      file_size:   fileSize,\n      file_path:   filePath,\n      uploaded_at: new Date().toISOString(),\n\n      // URLs d‚Äôupload direct\n      upload_rest_url: `${projectUrl}/storage/v1/object/${bucketName}/${filePath}`,\n      upload_s3_url:   `${projectUrl}/storage/v1/s3/${bucketName}/${filePath}`,\n    },\n    binary: { data: bin },\n  };\n});"},"name":"Path Builder","type":"n8n-nodes-base.code","position":[-288,1200],"id":"f1453071-dbc8-4588-bd04-2a152e15fec0","typeVersion":2},{"parameters":{"assignments":{"assignments":[{"id":"a680c564-36d6-4a60-869d-34af8349f15f","name":"id_attachment","value":"={{ $json.id }}","type":"string"},{"id":"f7aa66b9-6a46-45cf-8694-bc5fc78bf0f9","name":"Id_bucket","value":"={{ $('Edit Fields').item.json.Id_bucket }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[2288,928],"id":"dac2b38f-8b3f-4c67-b0b5-b0135039f087","name":"Edit Fields5"},{"parameters":{"jsCode":"return $input.all().map((item, index) => {\n  return {\n    json: {\n      index,\n      fullText: Array.isArray(item.json.text) ? item.json.text.join('\\n') : '',\n      Id_bucket: item.json.Id_bucket,\n      ...item.json\n    }\n  };\n});"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[2288,1136],"id":"65552d59-4abd-46ed-9ff8-32778840a699","name":"Code2"},{"parameters":{"assignments":{"assignments":[{"id":"effa1acf-5453-44b1-81ff-6201dc229822","name":"output","value":"={{ $json.output }}","type":"object"},{"id":"0f8b37cf-7199-4b0a-b109-d986aa6755cd","name":"Id_bucket2","value":"={{ $('Merge5').item.json.Id_bucket }}","type":"string"},{"id":"431a1084-4aee-4a6b-ae57-dc9c49d33888","name":"id_attachment","value":"={{ $('Merge5').item.json.id_attachment }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[5216,816],"id":"a1945b5f-97f7-4e8f-9cef-ecb3950db961","name":"Edit Fields4"},{"parameters":{"assignments":{"assignments":[{"id":"55f595c5-bf95-4ba4-a049-3f5bd2800864","name":"Id_bucket","value":"={{ $('Merge3').item.json.Id_bucket }}","type":"string"},{"id":"62051e15-6888-4fce-be6e-d4e8a758d6c5","name":"gmail_id","value":"={{ $('Merge3').item.json.gmail_id }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[3104,1408],"id":"3c9de00e-05d4-4c51-bb3e-07982083b902","name":"Edit Fields6"},{"parameters":{"mode":"combine","fieldsToMatchString":"Id_bucket","options":{}},"type":"n8n-nodes-base.merge","typeVersion":3.1,"position":[2496,1008],"id":"6f7675b1-900c-46c9-9398-8385fa8ecef3","name":"Merge5"},{"parameters":{"mode":"combine","combineBy":"combineByPosition","options":{}},"type":"n8n-nodes-base.merge","typeVersion":3.1,"position":[2064,1200],"id":"9de6d738-d2b2-4426-85a0-60c8959f894f","name":"Merge6"},{"parameters":{"operation":"toText","sourceProperty":"text","options":{"encoding":"utf8"}},"type":"n8n-nodes-base.convertToFile","typeVersion":1.1,"position":[160,2160],"id":"333d1a97-f0d0-4d4b-b92d-ea367929b133","name":"Convert to File"},{"parameters":{"options":{"reset":false}},"type":"n8n-nodes-base.splitInBatches","typeVersion":3,"position":[-496,2064],"id":"3eabee88-5990-4d96-9db0-642dbbf359a3","name":"Loop Over Items"},{"parameters":{"method":"POST","url":"=https://supabasekong.eurekia-solutions.com/storage/v1/object/email-attachments/{{ $('Code3').item.json.filePath }}","authentication":"genericCredentialType","genericAuthType":"httpBearerAuth","sendHeaders":true,"headerParameters":{"parameters":[{"name":"  x-upsert","value":"true"}]},"sendBody":true,"contentType":"binaryData","inputDataFieldName":"data","options":{}},"name":"Upload to Storage1","type":"n8n-nodes-base.httpRequest","position":[384,2160],"id":"4d44697f-c103-43a4-b2a5-3361a56f1513","typeVersion":4.2,"credentials":{"httpBearerAuth":{"id":"LcmmlniTWcYXU9cu","name":"Bearer Auth supabase SERVICE KEY"}},"onError":"continueErrorOutput"},{"parameters":{"operation":"get","tableId":"emails","filters":{"conditions":[{"keyName":"idGraph","keyValue":"={{ $json.id_gmail }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[160,1968],"id":"2f5eddef-ecb2-4053-a144-edaadd999fbc","name":"Supabase2","credentials":{"supabaseApi":{"id":"c6pA96O6wOcfq8wb","name":"Supabase account"}}},{"parameters":{"assignments":{"assignments":[{"id":"a2f86bc2-2887-4cd3-a623-4bf35c992db2","name":"Key","value":"={{ $json.Key }}","type":"string"},{"id":"4264577f-642a-43d1-8079-dcd77c49c6b7","name":"Id_bucket","value":"={{ $json.Id }}","type":"string"},{"id":"9cbd3984-7a08-48a1-9304-7810911a1327","name":"id_gmail","value":"={{ $('Code3').item.json.id_gmail }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[608,2160],"id":"cc367b57-2f2e-441a-a9aa-d55f2c32e65a","name":"Edit Fields7"},{"parameters":{"assignments":{"assignments":[{"id":"4b6fdf84-ad82-4045-81bc-f03a75512275","name":"Key","value":"={{ $json.Key }}","type":"string"},{"id":"b3f56fea-a23d-4c4d-bef2-83235c5ddff8","name":"Id_bucket","value":"={{ $json.Id_bucket }}","type":"string"},{"id":"78bbface-6f1c-4a92-ad4c-c531ce6e1da3","name":"id_gmail","value":"={{ $json.id_gmail }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-64,1968],"id":"f9b69f78-53c0-44d3-aef8-c77b3ba40782","name":"Edit Fields8"},{"parameters":{"assignments":{"assignments":[{"id":"1de02bc6-d6cf-429c-8c50-8cc8b1e917b6","name":"text","value":"={{ $json.text }}","type":"string"},{"id":"a03fdb3a-dd20-4bb8-9a58-50c46464f49a","name":"id_gmail","value":"={{ $json.id }}","type":"string"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-272,2160],"id":"6f07f495-4dba-4dca-95ae-c2a5375b28c6","name":"Edit Fields9"},{"parameters":{"jsCode":"// Param√®tres d'entr√©e\nconst emailId = $json.id_gmail || 'unknown_id';\nconst fileName = 'email.txt';\n\n// Cr√©e la date du jour au format YYYY-MM-DD\nconst today = new Date().toISOString().split('T')[0];\n\n// Nettoie le nom de fichier (remplace les caract√®res sp√©ciaux)\nconst safeFileName = fileName.replace(/[\\[\\]#?\\\\]/g, '_');\n\n// Construit le chemin final dans le bucket\nconst filePath = `${today}/${emailId}/${safeFileName}`;\n\n// Ajoute le champ filePath √† l'item\nreturn [\n  {\n    json: {\n      ...$json,\n      filePath, // ‚Üê utilisable dans ton node d'upload\n    },\n    binary: $binary, // Si tu as d√©j√† un fichier binaire attach√©\n  }\n];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-64,2160],"id":"63720e9d-848e-4442-9431-b0a7ca321fa5","name":"Code3"},{"parameters":{"jsCode":"return $input.all().map(item => {\n  const fullKey = item.json.Key || '';\n  const cleanKey = fullKey.replace(/^email-attachments\\//, '');\n\n  return {\n    json: {\n      ...item.json,\n      Key: cleanKey\n    }\n  };\n});"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-272,1968],"id":"729c8c25-3b26-4f59-b9c1-7eb2192afc9a","name":"Code4"},{"parameters":{"tableId":"email_attachments","fieldsUi":{"fieldValues":[{"fieldId":"file_name","fieldValue":"email.txt"},{"fieldId":"file_path","fieldValue":"={{ $('Edit Fields8').item.json.Key }}"},{"fieldId":"email_id","fieldValue":"={{ $json.id }}"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[384,1968],"id":"164fe0a8-4fbd-42ba-aee4-6e073e4fdf6c","name":"Supabase1","credentials":{"supabaseApi":{"id":"c6pA96O6wOcfq8wb","name":"Supabase account"}}},{"parameters":{},"type":"n8n-nodes-base.manualTrigger","typeVersion":1,"position":[-4000,1152],"id":"69782c2f-bd14-4c07-9bd5-cab37ab5043b","name":"When clicking ‚ÄòTest workflow‚Äô"},{"parameters":{"rules":{"values":[{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"leftValue":"={{ $json.bodyPreview }}","rightValue":"^-- RAPPEL --","operator":{"type":"string","operation":"regex"},"id":"eba25079-2e15-432b-9f9d-252549d72028"}],"combinator":"and"}},{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"d79cc8c2-b04b-44a2-8d0e-c2534ae74428","leftValue":"={{ $json.from.emailAddress.address }}","rightValue":"3cx","operator":{"type":"string","operation":"contains"}}],"combinator":"and"}}]},"options":{"fallbackOutput":"extra"}},"type":"n8n-nodes-base.switch","typeVersion":3.2,"position":[240,2432],"id":"6b668664-6e8d-43b9-905f-1617ca8e67bf","name":"Switch"},{"parameters":{"jsCode":"for (const item of $input.all()) {\n  const html = item.json.body ?? '';\n  // Enl√®ve <img ...> (auto-ferm√©e ou non) et un √©ventuel </img>\n  item.json.body = html.replace(\n    /<img\\b[^>]*?(?:\\/>|>)(?:\\s*<\\/img>)?/gi,\n    ''\n  );\n}\nreturn $input.all();"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-368,32],"id":"2793595e-ce3c-434d-8813-ad30aa00403e","name":"regex img","notesInFlow":true,"notes":"Nettoie par regex des images enco√©es dan sle texte"},{"parameters":{},"type":"n8n-nodes-base.debugHelper","typeVersion":1,"position":[2064,1408],"id":"7bedf630-39c1-4ed9-91ef-1b750e1ef15a","name":"DebugHelper"},{"parameters":{"content":"## d√©placement des emails apr√®s traitements","height":608,"width":6000},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-1872,2384],"id":"8369a793-8938-4009-802a-c84d8f99381e","name":"Sticky Note"},{"parameters":{"throwErrorMessage":"probl√®me url upload supabase (v√©rifier VPS)"},"type":"n8n-nodes-base.debugHelper","typeVersion":1,"position":[432,1248],"id":"dbb43e20-4d00-4a9e-8e76-7f2530cb4487","name":"DebugHelper1"},{"parameters":{"jsCode":"return $input.all().filter(item => {\n  const text = (item.json.fullText ?? '').replace(/\\s+/g, '');\n  return text.length > 0;\n});"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[2704,1008],"id":"8077e8e6-0df1-4768-97d3-fc119d9429c9","name":"Code5"},{"parameters":{"jsCode":"const MIN_SIZE = 25 * 1024; // 45 Ko en octets\n\n// Fonction utilitaire pour convertir \"229 kB\", \"7.05 kB\", etc. en octets\nfunction parseSize(sizeStr) {\n  const match = sizeStr.match(/^([\\d.]+)\\s*(kB|MB|B)$/i);\n  if (!match) return 0;\n\n  const value = parseFloat(match[1]);\n  const unit = match[2].toLowerCase();\n\n  if (unit === 'kb') return value * 1024;\n  if (unit === 'mb') return value * 1024 * 1024;\n  if (unit === 'b')  return value;\n  return 0;\n}\n\n// Filtrer les items en fonction de leur taille,\n// mais garder les PDF quelle que soit leur taille\nconst filtered = $input.all().filter(item => {\n  const fileName = item.json.file_name || ''; // ou le champ correspondant dans tes donn√©es\n  const sizeStr = item.json.file_size;\n  const bytes = parseSize(sizeStr);\n\n  const isPDF = /\\.pdf$/i.test(fileName);\n  return isPDF || bytes >= MIN_SIZE;\n});\n\nreturn filtered;"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-64,1200],"id":"7cff8455-add6-40ac-8273-642229817540","name":"sizeFilter1 sauf pdf"},{"parameters":{"conditions":{"options":{"caseSensitive":true,"leftValue":"","typeValidation":"strict","version":2},"conditions":[{"id":"0a072ceb-d620-4cf2-bac5-d79dfa9fe3a9","leftValue":"={{$json.output.type}}","rightValue":"paiement","operator":{"type":"string","operation":"equals"}}],"combinator":"and"},"options":{}},"type":"n8n-nodes-base.if","typeVersion":2.2,"position":[3312,784],"id":"2c9b2c43-9702-45d7-a8aa-ceb03083e67f","name":"If1"},{"parameters":{"text":"={{ $('Code5').item.json.fullText }}","schemaType":"fromJson","jsonSchemaExample":"{\n\n\t\t\"client_adresse\" : \"12 Rue de la R√©publique\",\n\t\t\"client_code_postal\" : \"69002\",\n\t\t\"client_email\" : \"claire.morel@francia.fr\",\n\t\t\"client_id\" : null,\n\t\t\"client_prenom_nom\" : \"Claire Morel\",\n\t\t\"client_raison_sociale\" : \"FRANCIA SARL\",\n\t\t\"client_tel\" : \"04 72 56 23 89\",\n\t\t\"client_ville\" : \"Lyon\",\n\n\t\t\"lese_adresse\" : \"45 Avenue des Tilleuls\",\n\t\t\"lese_code_postal\" : \"69008\",\n\t\t\"lese_email\" : \"jean.dupont@example.com\",\n\t\t\"lese_info_compl\" : null,\n\t\t\"lese_nom_prenom\" : \"Jean Dupont\",\n\t\t\"lese_tel\" : \"06 78 90 12 34\",\n\t\t\"lese_ville\" : \"Lyon\",\n\n\t\t\"reference\" : \"AX123456\",\n  \t\t\"numDevis\" : \"D25073703\",\n  \t\t\"type\" : \"intervention\"  \n\t}","options":{"systemPromptTemplate":"=# contexte\ntu es un analyseur de PDF hors pair. Tu analyses les pi√®ces jointes en PDF envoy√© par un client (r√©gie, syndic) √† la soci√©t√© Sapitec qui fait des interventions.\n\n\n# ta mission\n\nTu es capable de rep√©rer qui est le client (syndic, r√©gie, celui qui fait la demande) et chez qui il faut intervenir (l√©s√©, lieu d'intervention) en extrayant les coordonn√©es n√©cessaires de chacun.\n\n**IMPORTANT** Si tu ne trouves pas une information tu n'inventes jamais rien, tu laisses vide.\n\ntu travailles pour la soci√©t√© SAPITEC, le client ou le l√©s√© ne peuvent JAMAIS √™tre SAPITEC, 3 Rue Louis Lachenal, 69740 Genas.\n\ncas d'une COMMANDE  (devis sapitec valid√©) : \n* Parfois tu devras analyser un PDF qui sera le devis de la soci√©t√© SAPITEC, qui a √©t√© envoy√© au client (ent√™te et pied de page sapitec, pr√©sence de \"Genas le :\" puis la date. Dans ce cas seulement tu devras r√©cup√©rer le num√©ro de devis qui est toujours sous la forme D + 8chiffres. Exemple \"D25073703\". Le mettre dans la cl√© \"numDevis\"\n* si c'est une commande, le lese_nom_prenom ne peut en aucun cas √™tre la m√™me personne que le client_prenom_nom.\n * les infos du l√©s√© de l'intervention est en g√©n√©ral pr√©cis√© dans \"Affaire:\""}},"type":"@n8n/n8n-nodes-langchain.informationExtractor","typeVersion":1,"position":[3664,976],"id":"7d47ec32-4c0c-48f2-8bfa-ce055b82b1c5","name":"commande extractor"},{"parameters":{"model":{"__rl":true,"value":"gpt-4.1-mini","mode":"list","cachedResultName":"gpt-4.1-mini"},"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[3600,848],"id":"cccda807-1753-436c-b9f9-50e985feeb55","name":"OpenAI Chat Model3","credentials":{"openAiApi":{"id":"w9SlUWDfkUpRmR78","name":"OpenAi account"}}},{"parameters":{"text":"={{ $('Code5').item.json.fullText }}","schemaType":"fromJson","jsonSchemaExample":"{\n  \"nomClient\": \"Lamy Lyon Point du Jour\",\n  \"adresseClient\": \"51 Avenue du Point du Jour\",\n  \"codePostalClient\": \"69005\",\n  \"villeClient\": \"Lyon\",\n  \"prenomContact\": null,\n  \"nomContact\": null,\n  \"factures\": [\n    {\n      \"numeroFacture\": \"18526\",\n      \"montant\": 1072.50\n    },\n    {\n      \"numeroFacture\": \"18232\",\n      \"montant\": 528.00\n    }\n  ]\n}","options":{"systemPromptTemplate":"=Tu es un extracteur de donn√©es pour des avis de virement PDF de syndics immobiliers (Citya, Lamy, Immosquare, etc.).\n\nTu travailles pour la soci√©t√© SAPITEC rue Louis Lachenal, donc le client **ne peut pas √™tre SAPITEC** puisque le client envoie un email √† Sapitec\n\nSi tu ne trouves pas le client dans l'ent√™te car c'est une image sur le pdf, alors vraisemblablement tu trouveras les infos en pied de page.\n\nSi tu ne trouves pas d'autres infos que celels de sapitec je pr√©f√®res que tu ne renseignes pas les infos client du tout.\n\nTa mission est d‚Äôanalyser le contenu textuel du PDF et d‚Äôen extraire les informations cl√©s suivantes.\n\n‚öôÔ∏è Donn√©es √† extraire :\n- **nomClient** : nom du syndic ou soci√©t√© √©mettrice du virement (ex. Citya, Lamy, Immosquare, etc.)\n- **adresseClient** : adresse postale compl√®te figurant sur le document pour le syndic\n- **codePostalClient**\n- **villeClient**\n- **prenomContact** : pr√©nom du contact s‚Äôil est identifiable (sinon vide)\n- **nomContact** : nom du contact s‚Äôil est identifiable (sinon vide)\n- **factures** : tableau des factures r√©gl√©es avec :\n  - **numeroFacture** : r√©f√©rence √† 5 chiffres mentionn√©e (ex. 18940, 18526‚Ä¶)\n  - **montant** : montant TTC pay√© pour cette facture, au format nombre (ex. 539.00)\n\nüßæ R√®gles :\n- Ignore les IBAN, num√©ros de virement, mentions l√©gales et salutations.\n- Si plusieurs factures sont list√©es, tu dois toutes les inclure dans le tableau `factures`.\n- Si une donn√©e n‚Äôest pas pr√©sente, renvoie `null` pour cette cl√©.\n- Les montants doivent √™tre des nombres (pas de cha√Ænes).\n\nüß© R√©sultat attendu :\nRetourne uniquement du JSON strict, sans texte ni commentaire."}},"type":"@n8n/n8n-nodes-langchain.informationExtractor","typeVersion":1,"position":[3664,640],"id":"8cc697d4-c878-4d6d-a132-fb0662e4c6ef","name":"paiement Extractor"},{"parameters":{"text":"={{ $json.fullText }}","attributes":{"attributes":[{"name":"type","description":"autre","required":true}]},"options":{"systemPromptTemplate":"=tu es un analyseur de PDF comp√©tent, tu dois simplement classifier le pdf en me disant s'il s'agit d'un avis de paiement, virement, r√©√®glement de facture ou d'autre chose.\n\nSi c'est le cas tu d√©finis le type comme \"paiement\", sinon comme \"autre\"\n\nUn paiement s'appelle en g√©n√©ral \"avis de virement\", \"avis de paiement\", \"relev√© de situation\" ou en tout cas sugg√®re une liste de r√®glements qui ont √©t√© fait pour une ou plusieurs factures. \n\n** ne pas confondre **\nAvec par exemple un devis sapitec sign√©. Le devis contient un descriptif de travaux √† faire avec des prix, √† un num√©ro qui commence par D.....\n\ntype ne peut pas √™tre null\n"}},"type":"@n8n/n8n-nodes-langchain.informationExtractor","typeVersion":1.2,"position":[2912,1008],"id":"888300bb-1b17-4fe8-be8c-52a22b6f3e43","name":"Information Extractor"},{"parameters":{"model":{"__rl":true,"value":"gpt-4.1-mini","mode":"list","cachedResultName":"gpt-4.1-mini"},"options":{}},"type":"@n8n/n8n-nodes-langchain.lmChatOpenAi","typeVersion":1.2,"position":[2848,1216],"id":"0a005177-0483-418b-8589-ed1d3b7592de","name":"OpenAI Chat Model4","credentials":{"openAiApi":{"id":"w9SlUWDfkUpRmR78","name":"OpenAi account"}}},{"parameters":{"operation":"update","tableId":"emails","filters":{"conditions":[{"keyName":"id","condition":"eq","keyValue":"={{ $('Merge').item.json.email_id }}"}]},"fieldsUi":{"fieldValues":[{"fieldId":"client_raison_sociale","fieldValue":"={{ $json.output.nomClient }}"},{"fieldId":"client_adresse","fieldValue":"={{ $json.output.adresseClient }}"},{"fieldId":"client_code_postal","fieldValue":"={{ $json.output.codePostalClient }}"},{"fieldId":"client_ville","fieldValue":"={{ $json.output.villeClient }}"},{"fieldId":"client_prenom_nom","fieldValue":"={{ $json.output.prenomContact }} {{ $json.output.nomContact }}"},{"fieldId":"type","fieldValue":"paiement"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[4016,640],"id":"2f9b261c-458f-4ce9-ad15-f7db35bf17de","name":"Update a row1","credentials":{"supabaseApi":{"id":"c6pA96O6wOcfq8wb","name":"Supabase account"}}},{"parameters":{"assignments":{"assignments":[{"id":"6714ac6a-6179-443e-aa70-1eec4d35a637","name":"output","value":"={{ $('paiement Extractor').item.json.output }}","type":"object"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[4224,640],"id":"bbfc5084-a55f-47b1-8bec-02215a9dfd5c","name":"Edit Fields10"},{"parameters":{"assignments":{"assignments":[{"id":"048ac137-749b-4341-affb-4c7a3ee1d7f0","name":"test","value":true,"type":"boolean"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-3728,1152],"id":"e6cc7af2-19a6-4184-afd1-133b3fca6cd1","name":"_isTestTrue"},{"parameters":{"assignments":{"assignments":[{"id":"048ac137-749b-4341-affb-4c7a3ee1d7f0","name":"test","value":false,"type":"boolean"}]},"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-3728,1312],"id":"f780994a-c569-4e8e-980a-06e73df5defc","name":"_isTestFalse"},{"parameters":{"content":"## lancement test\n\nPour emails label = test\n"},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-4160,928],"id":"4fa58f71-388a-4038-9119-92cd9f3261c4","name":"Sticky Note3"},{"parameters":{"content":"## cron production"},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-4144,1472],"id":"c40d83a3-124b-43e5-abe7-9980e902f467","name":"Sticky Note4"},{"parameters":{"assignments":{"assignments":[{"id":"d1b6f8b1-2b3a-41d4-8688-504c5d986de8","name":"test","value":"={{ $('If2').item.json.test }}","type":"boolean"}]},"includeOtherFields":true,"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[-2080,1072],"id":"309e4d8f-6e4c-49a2-855d-4de6adb2300e","name":"set email test"},{"parameters":{"content":"## 2025_10_25\n\nLe workflow peut d√©sormais marcher en test ou prod selon qu'on active le trigger ou d√©clench√© par le CRON\n\nLes emails sont flagu√©s test ou non dans supabase automatiquement \n\nPasser en mode test dans FileMaker pour ramener les emails\n","height":304},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-4448,784],"id":"01de50b9-16cb-4563-875c-d41afa6550d4","name":"Sticky Note5"},{"parameters":{"operation":"getAll","returnAll":true,"output":"fields","fields":["receivedDateTime","from","bodyPreview","internetMessageId"],"filtersUI":{"values":{"filters":{"foldersToInclude":["AAMkAGNiOGI3MTg2LTBjNGYtNDhjZS05OGRhLWU4ZGFhYzdhNGYzOQAuAAAAAAAkihsQMtRtSrbzhm-L1fuDAQDO26NLfqfGRqpUyu1c3zfGAAboAfINAAA="],"receivedAfter":"={{ $json.email_date }}"}}},"options":{}},"type":"n8n-nodes-base.microsoftOutlook","typeVersion":2,"position":[-2832,896],"id":"64f89c33-efc8-4b62-9842-c5a5f2b3dc25","name":"Get many messages","webhookId":"faf119e8-a988-44b4-8b05-141f9d379f9c","credentials":{"microsoftOutlookOAuth2Api":{"id":"xQceaIQe7UpfOYSO","name":"Microsoft Outlook account sapitec"}}},{"parameters":{"sortFieldsUi":{"sortField":[{"fieldName":"receivedDateTime"}]},"options":{"disableDotNotation":false}},"type":"n8n-nodes-base.sort","typeVersion":1,"position":[-2560,896],"id":"3f13c9ce-c321-4c95-81d3-e5fbb356985a","name":"Sort"},{"parameters":{"maxItems":3},"type":"n8n-nodes-base.limit","typeVersion":1,"position":[-2368,896],"id":"7f456f35-a25c-4d58-987d-09a368da33b3","name":"Limit"},{"parameters":{"operation":"get","messageId":{"__rl":true,"value":"={{ $json.id }}","mode":"id"},"output":"fields","fields":["receivedDateTime","from","bodyPreview","hasAttachments","replyTo","sender","subject","webLink","body","toRecipients","internetMessageId"],"options":{"attachmentsPrefix":"attachment_","downloadAttachments":true}},"type":"n8n-nodes-base.microsoftOutlook","typeVersion":2,"position":[-1488,848],"id":"c9012d31-ae3b-4bbb-9247-2040ca80b263","name":"Get a message","webhookId":"faf119e8-a988-44b4-8b05-141f9d379f9c","credentials":{"microsoftOutlookOAuth2Api":{"id":"xQceaIQe7UpfOYSO","name":"Microsoft Outlook account sapitec"}},"onError":"continueErrorOutput"},{"parameters":{"jsCode":"const items = $input.all();\n\nfunction htmlToText(html) {\n  if (!html || typeof html !== \"string\") return \"\";\n  return html\n    // retire les blocs CSS et scripts\n    .replace(/<style[\\s\\S]*?<\\/style>/gi, '')\n    .replace(/<script[\\s\\S]*?<\\/script>/gi, '')\n    // remplace les balises <br> / <p> par des sauts de ligne\n    .replace(/<\\/p>|<br\\s*\\/?>/gi, '\\n')\n    // supprime toutes les autres balises\n    .replace(/<[^>]+>/g, '')\n    // d√©code les entit√©s HTML courantes\n    .replace(/&nbsp;/g, ' ')\n    .replace(/&amp;/g, '&')\n    .replace(/&quot;/g, '\"')\n    .replace(/&lt;/g, '<')\n    .replace(/&gt;/g, '>')\n    // nettoie les espaces et retours √† la ligne superflus\n    .replace(/\\n{3,}/g, '\\n\\n')\n    .replace(/[ \\t]{2,}/g, ' ')\n    .trim();\n}\n\nreturn items.map(item => {\n  const html = item.json.body || \"\";\n  const bodyText = htmlToText(html);\n  return {\n    json: {\n      ...item.json,\n      bodyText\n    }\n  };\n});"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-160,32],"id":"fcb4a14b-efa3-457f-9d3a-c42f572e6521","name":"nettoyer html"},{"parameters":{"assignments":{"assignments":[{"id":"a8df2c18-02bf-42ee-9da8-d10dc05dec3f","name":"attachments_count","value":"={{ $('Code').item.json.attachments_count }}","type":"number"}]},"includeOtherFields":true,"options":{}},"type":"n8n-nodes-base.set","typeVersion":3.4,"position":[800,928],"id":"16314497-7ca5-4921-8c6f-b057531d94af","name":"add attach. count"},{"parameters":{"errorMessage":"impossible d'updater email"},"type":"n8n-nodes-base.stopAndError","typeVersion":1,"position":[1808,128],"id":"a0d145c8-cb33-4213-ab54-3afd18683441","name":"Stop and Error1"},{"parameters":{"content":"## r√©cup√©ration des emails","height":608,"width":6016,"color":4},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-1904,-224],"id":"7bf29bf7-2f76-49aa-bfa6-313153b1498a","name":"Sticky Note1"},{"parameters":{"content":"## enregistrement des attachmments dans buckets + mettre url dans supabase email-attachments","height":576,"width":6000,"color":3},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-1888,1840],"id":"12f05746-769d-42cb-899d-df137cdbb1cf","name":"Sticky Note2"},{"parameters":{"jsCode":"const output = [];\n\nfor (const item of $input.all()) {\n  // ID de l‚Äôe-mail (priorit√© √† email_id s‚Äôil existe)\n  const emailId = item.json.id;\n  if (!emailId) continue;\n    const MessageId = item.json.internetMessageId;\n  const internetMessageId = (MessageId || '')\n  .replace(/^<|>$/g, '')  // retire les chevrons d√©but/fin\n  .trim();\n\n  // Sujet : ¬´ non defini ¬ª si vide ou absent\n  const subject = (item.json.subject && item.json.subject.trim())\n    ? item.json.subject\n    : 'non defini';\n\n  // Corps : text en priorit√©, sinon html, sinon cha√Æne vide\nconst body = item.json.body?.content ?? item.json.body ?? '';\n\n  const dateEmail = item.json.receivedDateTime;\n  \nconst to = item.json.toRecipients?.[0]?.emailAddress?.address ?? '';\n  \nconst isTest = $('testFrom').first().json.test ?? false;\n  \nconst from = item.json.from?.emailAddress?.address\n               || item.json.sender?.emailAddress?.address\n               || 'exp√©diteur inconnu';\n  // Comptage des pi√®ces jointes\n  let count = 0;\n  if (item.binary && typeof item.binary === 'object' && Object.keys(item.binary).length) {\n    count = Object.keys(item.binary).length;\n  } else if (Array.isArray(item.json.attachments)) {\n    count = item.json.attachments.length;\n  }\n\n  // Construction de la sortie\n  output.push({\n    json: {\n      email_id: emailId,\n      subject,\n      body,\n      attachments_count: count,\n      dateEmail,\n      from,\n      to,\n      isTest,\n      internetMessageId\n    }\n  });\n}\n\nreturn output;"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-592,32],"id":"11c8889e-c654-4532-92a8-3de57ad98e1d","name":"Code"},{"parameters":{"content":"## cr√©ations des pi√®ces jointes dans supabes et analyse IA","height":1360,"width":6032,"color":5},"type":"n8n-nodes-base.stickyNote","typeVersion":1,"position":[-1904,400],"id":"0cccaea5-8dfe-4320-a970-e89b42e3ed75","name":"Sticky Note6"},{"parameters":{"mode":"combine","combineBy":"combineByPosition","options":{}},"type":"n8n-nodes-base.merge","typeVersion":3.2,"position":[-960,2720],"id":"7f90d658-b0ef-4b7a-bf09-5c5a0caf7709","name":"Merge2"},{"parameters":{"operation":"move","messageId":{"__rl":true,"value":"={{ $json.id }}","mode":"id"},"folderId":{"__rl":true,"value":"AAMkAGNiOGI3MTg2LTBjNGYtNDhjZS05OGRhLWU4ZGFhYzdhNGYzOQAuAAAAAAAkihsQMtRtSrbzhm-L1fuDAQDO26NLfqfGRqpUyu1c3zfGAAboAfIOAAA=","mode":"list","cachedResultName":"test Trait√©","cachedResultUrl":"https://outlook.office365.com/mail/AAMkAGNiOGI3MTg2LTBjNGYtNDhjZS05OGRhLWU4ZGFhYzdhNGYzOQAuAAAAAAAkihsQMtRtSrbzhm%2FL1fuDAQDO26NLfqfGRqpUyu1c3zfGAAboAfIOAAA%3D"}},"type":"n8n-nodes-base.microsoftOutlook","typeVersion":2,"position":[1024,2704],"id":"e645aaa0-18e4-4b5d-945c-b59473f0e8e9","name":"Move a message1","webhookId":"a9aafeb1-90ca-4e01-8e01-1e2aaab6c17d","credentials":{"microsoftOutlookOAuth2Api":{"id":"xQceaIQe7UpfOYSO","name":"Microsoft Outlook account sapitec"}}},{"parameters":{"operation":"update","messageId":{"__rl":true,"value":"={{ $json.id }}","mode":"id"},"updateFields":{"categories":["Cat√©gorie bleue"]}},"type":"n8n-nodes-base.microsoftOutlook","typeVersion":2,"position":[624,2528],"id":"399ca8ad-3640-4d0b-8458-9d15e8df2007","name":"Update a message","webhookId":"c7476838-6b33-4b0c-9562-1bb3640b946e","credentials":{"microsoftOutlookOAuth2Api":{"id":"xQceaIQe7UpfOYSO","name":"Microsoft Outlook account sapitec"}}},{"parameters":{"operation":"update","messageId":{"__rl":true,"value":"={{ $json.id }}","mode":"id"},"updateFields":{"categories":["Cat√©gorie rouge"]}},"type":"n8n-nodes-base.microsoftOutlook","typeVersion":2,"position":[624,2384],"id":"0e5f45a9-fad4-4c4d-b15a-da9d25fd60b9","name":"Update a message1","webhookId":"c7476838-6b33-4b0c-9562-1bb3640b946e","credentials":{"microsoftOutlookOAuth2Api":{"id":"xQceaIQe7UpfOYSO","name":"Microsoft Outlook account sapitec"}}},{"parameters":{"operation":"update","tableId":"emails","filters":{"conditions":[{"keyName":"gmail_id","condition":"eq","keyValue":"={{ $('clean internetMessageId').item.json.internetMessageId }}"}]},"fieldsUi":{"fieldValues":[{"fieldId":"is_complete","fieldValue":"True"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[1264,2832],"id":"b9433707-e328-4d4e-9d89-59ac12bc1b50","name":"is_complete True1","credentials":{"supabaseApi":{"id":"c6pA96O6wOcfq8wb","name":"Supabase account"}}},{"parameters":{"jsCode":"const items = $input.all();\n\nfunction cleanMessageId(rawId = '') {\n  // retire les chevrons et espaces superflus\n  const id = rawId.replace(/^<|>$/g, '').trim();\n\n  // version \"safe\" pour stockage dans un bucket (pas de caract√®res sp√©ciaux)\n  const safe = id.replace(/[^a-zA-Z0-9._-]/g, '_');\n\n  return { id, safe };\n}\n\nreturn items.map(item => {\n  const rawId = item.json.internetMessageId || '';\n  const { id: cleanId, safe: safeId } = cleanMessageId(rawId);\n\n  return {\n    json: {\n      ...item.json,\n      internetMessageId: cleanId,  // version nettoy√©e\n      internetMessageId_safe: safeId  // version bucket-safe\n    }\n  };\n});"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-672,2720],"id":"668a9225-822f-4055-b09c-00c4bd9337b4","name":"clean internetMessageId"},{"parameters":{"url":"=https://supabasekong.eurekia-solutions.com/rest/v1/emails","authentication":"predefinedCredentialType","nodeCredentialType":"supabaseApi","sendQuery":true,"queryParameters":{"parameters":[{"name":"select","value":"=email_date, date"},{"name":"order","value":"email_date.desc.nullslast"},{"name":"limit","value":"1"},{"name":"z_isOutlook","value":"eq.true"}]},"options":{}},"name":"date last message","type":"n8n-nodes-base.httpRequest","position":[-3248,896],"id":"69e7e327-23ed-4916-8205-e317e9a80109","typeVersion":4.2,"alwaysOutputData":true,"credentials":{"httpBearerAuth":{"id":"LcmmlniTWcYXU9cu","name":"Bearer Auth supabase SERVICE KEY"},"supabaseApi":{"id":"c6pA96O6wOcfq8wb","name":"Supabase account"}},"onError":"continueRegularOutput"},{"parameters":{"jsCode":"// Objectif : produire une date UTC valide pour Outlook\n// Si $json.email_date est vide ‚Üí date du jour - 3 jours\n\nconst inputDate = $json.email_date;\nconst tz = 'Europe/Paris';\nlet baseDate;\n\n// 1Ô∏è‚É£ D√©termine la date de r√©f√©rence\nif (inputDate && !isNaN(new Date(inputDate).getTime())) {\n  baseDate = new Date(inputDate);\n  console.log(\"üí° Email date re√ßue:\", inputDate);\n} else {\n  baseDate = new Date();\n  baseDate.setDate(baseDate.getDate() - 3);\n  console.log(\"‚ö†Ô∏è Pas de date re√ßue, on prend aujourd'hui - 3 jours:\", baseDate.toISOString());\n}\n\n// 2Ô∏è‚É£ Calcule l‚Äôoffset du fuseau Europe/Paris (g√®re √©t√©/hiver)\nconst fmt = new Intl.DateTimeFormat('en-US', { timeZone: tz, timeZoneName: 'shortOffset' });\nconst parts = fmt.formatToParts(baseDate);\nconst tzPart = parts.find(p => p.type === 'timeZoneName')?.value || 'GMT+00';\n\nconst match = tzPart.match(/GMT([+-])(\\d{1,2})(?::?(\\d{2}))?/);\nlet offsetHours = 0;\n\nif (match) {\n  const sign = match[1] === '+' ? 1 : -1;\n  const hours = parseInt(match[2] || '0', 10);\n  const minutes = parseInt(match[3] || '0', 10);\n  offsetHours = sign * (hours + minutes / 60);\n}\n\nconsole.log(\"üïì D√©calage Paris (h):\", offsetHours);\n\n// 3Ô∏è‚É£ Convertit heure locale Paris ‚Üí UTC\nconst correctedUtc = new Date(baseDate.getTime() - offsetHours * 3600 * 1000);\nconst correctedUtcIso = correctedUtc.toISOString();\n\nconsole.log(\"‚úÖ Date UTC finale:\", correctedUtcIso);\n\n// 4Ô∏è‚É£ Toujours retourner quelque chose\nreturn [{ json: { email_date_graph_utc: correctedUtcIso } }];"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-3040,896],"id":"61b5f114-8db5-409e-be6b-94f30c4f727e","name":"conversion utc","disabled":true},{"parameters":{"operation":"move","messageId":{"__rl":true,"value":"={{ $json.id }}","mode":"id"},"folderId":{"__rl":true,"value":"AAMkAGNiOGI3MTg2LTBjNGYtNDhjZS05OGRhLWU4ZGFhYzdhNGYzOQAuAAAAAAAkihsQMtRtSrbzhm-L1fuDAQDO26NLfqfGRqpUyu1c3zfGAAboAfIOAAA=","mode":"list","cachedResultName":"test Trait√©","cachedResultUrl":"https://outlook.office365.com/mail/AAMkAGNiOGI3MTg2LTBjNGYtNDhjZS05OGRhLWU4ZGFhYzdhNGYzOQAuAAAAAAAkihsQMtRtSrbzhm%2FL1fuDAQDO26NLfqfGRqpUyu1c3zfGAAboAfIOAAA%3D"}},"type":"n8n-nodes-base.microsoftOutlook","typeVersion":2,"position":[1024,2384],"id":"94a0c98a-333a-404f-b616-93243835dde9","name":"Move a message","webhookId":"a9aafeb1-90ca-4e01-8e01-1e2aaab6c17d","credentials":{"microsoftOutlookOAuth2Api":{"id":"xQceaIQe7UpfOYSO","name":"Microsoft Outlook account sapitec"}}},{"parameters":{"operation":"update","tableId":"emails","filters":{"conditions":[{"keyName":"gmail_id","condition":"eq","keyValue":"={{ $('clean internet id bis').item.json.internetMessageId }}"}]},"fieldsUi":{"fieldValues":[{"fieldId":"is_complete","fieldValue":"True"}]}},"type":"n8n-nodes-base.supabase","typeVersion":1,"position":[1264,2384],"id":"0b809e4b-0301-4613-9588-1e5133d626fd","name":"is_complete True","credentials":{"supabaseApi":{"id":"c6pA96O6wOcfq8wb","name":"Supabase account"}}},{"parameters":{"jsCode":"const items = $input.all();\n\nfunction cleanMessageId(rawId = '') {\n  // retire les chevrons et espaces superflus\n  const id = rawId.replace(/^<|>$/g, '').trim();\n\n  // version \"safe\" pour stockage dans un bucket (pas de caract√®res sp√©ciaux)\n  const safe = id.replace(/[^a-zA-Z0-9._-]/g, '_');\n\n  return { id, safe };\n}\n\nreturn items.map(item => {\n  const rawId = item.json.internetMessageId || '';\n  const { id: cleanId, safe: safeId } = cleanMessageId(rawId);\n\n  return {\n    json: {\n      ...item.json,\n      internetMessageId: cleanId,  // version nettoy√©e\n      internetMessageId_safe: safeId  // version bucket-safe\n    }\n  };\n});"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[-672,2464],"id":"2ee16c41-8ca0-4bc7-b4e5-ff5c7c4b199b","name":"clean internet id bis"},{"parameters":{"operation":"getAll","returnAll":true,"output":"fields","fields":["receivedDateTime","from","bodyPreview","internetMessageId"],"filtersUI":{"values":{"filters":{"foldersToInclude":["AAMkAGNiOGI3MTg2LTBjNGYtNDhjZS05OGRhLWU4ZGFhYzdhNGYzOQAuAAAAAAAkihsQMtRtSrbzhm-L1fuDAQDO26NLfqfGRqpUyu1c3zfGAAboAfINAAA="],"receivedAfter":"={{ $json.email_date }}"}}},"options":{}},"type":"n8n-nodes-base.microsoftOutlook","typeVersion":2,"position":[-3104,624],"id":"df6e631b-83b7-4615-9dba-acf85cb7df7d","name":"Get many messages1","webhookId":"faf119e8-a988-44b4-8b05-141f9d379f9c","credentials":{"microsoftOutlookOAuth2Api":{"id":"xQceaIQe7UpfOYSO","name":"Microsoft Outlook account sapitec"}}},{"parameters":{"url":"=https://supabasekong.eurekia-solutions.com/rest/v1/emails","authentication":"predefinedCredentialType","nodeCredentialType":"supabaseApi","sendQuery":true,"queryParameters":{"parameters":[{"name":"select","value":"=email_date, date"},{"name":"order","value":"email_date.desc.nullslast"},{"name":"limit","value":"1"},{"name":"z_isOutlook","value":"eq.true"}]},"options":{}},"name":"date last message1","type":"n8n-nodes-base.httpRequest","position":[-3408,624],"id":"5b088342-7cef-4942-b843-3890e3602105","typeVersion":4.2,"alwaysOutputData":true,"credentials":{"httpBearerAuth":{"id":"LcmmlniTWcYXU9cu","name":"Bearer Auth supabase SERVICE KEY"},"supabaseApi":{"id":"c6pA96O6wOcfq8wb","name":"Supabase account"}},"onError":"continueRegularOutput"},{"parameters":{"jsCode":"const runId = $execution.id;\n\nreturn $input.all().map(item => ({\n  json: {\n    ...item.json,\n    n8n_execution_id: runId\n  }\n}));"},"type":"n8n-nodes-base.code","typeVersion":2,"position":[48,32],"id":"3b5064db-ddcd-4afb-a208-d262a5aa11bc","name":"n8n_execution_id"},{"parameters":{},"type":"n8n-nodes-base.merge","typeVersion":3.2,"position":[4736,688],"id":"5bed443f-83e8-467b-8408-c5a89974b341","name":"Merge7"},{"parameters":{"operation":"getAll","returnAll":true,"output":"fields","fields":["receivedDateTime","from","bodyPreview","internetMessageId"],"filtersUI":{"values":{"filters":{"foldersToInclude":["AAMkAGNiOGI3MTg2LTBjNGYtNDhjZS05OGRhLWU4ZGFhYzdhNGYzOQAuAAAAAAAkihsQMtRtSrbzhm-L1fuDAQDO26NLfqfGRqpUyu1c3zfGAAboAfINAAA="]}}},"options":{}},"type":"n8n-nodes-base.microsoftOutlook","typeVersion":2,"position":[-2848,1184],"id":"3d57ca2a-18cf-4f7d-9f45-46982415ca40","name":"Get many messages2","webhookId":"faf119e8-a988-44b4-8b05-141f9d379f9c","credentials":{"microsoftOutlookOAuth2Api":{"id":"xQceaIQe7UpfOYSO","name":"Microsoft Outlook account sapitec"}}}],"connections":{"Insert Email":{"main":[[{"node":"add attach. count","type":"main","index":0},{"node":"prompt","type":"main","index":0}]]},"Upload to Storage":{"main":[[{"node":"Edit Fields","type":"main","index":0}],[{"node":"DebugHelper1","type":"main","index":0}]]},"Insert Attachment Row":{"main":[[{"node":"Edit Fields5","type":"main","index":0}]]},"split attachments":{"main":[[{"node":"Path Builder","type":"main","index":0}]]},"Code1":{"main":[[{"node":"Merge","type":"main","index":0}]]},"Merge":{"main":[[{"node":"Insert Attachment Row","type":"main","index":0},{"node":"Merge3","type":"main","index":0}]]},"OpenAI Chat Model":{"ai_languageModel":[[{"node":"cat√©goriser email","type":"ai_languageModel","index":0}]]},"prompt":{"main":[[{"node":"cat√©goriser email","type":"main","index":0},{"node":"Merge1","type":"main","index":1}]]},"Merge1":{"main":[[{"node":"update_email","type":"main","index":0}]]},"cat√©goriser email":{"main":[[{"node":"Merge1","type":"main","index":0}]]},"Schedule Trigger":{"main":[[{"node":"_isTestFalse","type":"main","index":0}]]},"testFrom":{"main":[[{"node":"clean internet id bis","type":"main","index":0}],[{"node":"Get a message","type":"main","index":0},{"node":"Merge2","type":"main","index":1}]]},"If2":{"main":[[{"node":"date last message","type":"main","index":0}],[{"node":"Get many messages2","type":"main","index":0}]]},"getEmailAndAttach":{"main":[[]]},"If3":{"main":[[{"node":"Move a message1","type":"main","index":0}],[{"node":"is_complete True1","type":"main","index":0}]]},"Edit Fields":{"main":[[{"node":"Merge","type":"main","index":1}]]},"If4":{"main":[[{"node":"Merge3","type":"main","index":1}]]},"Extract from File":{"main":[[{"node":"Merge6","type":"main","index":0}],[{"node":"DebugHelper","type":"main","index":0}]]},"OpenAI Chat Model1":{"ai_languageModel":[[{"node":"commande extractor","type":"ai_languageModel","index":0}]]},"Merge3":{"main":[[{"node":"Extract from File","type":"main","index":0},{"node":"Merge6","type":"main","index":1}]]},"Merge4":{"main":[[{"node":"Supabase","type":"main","index":0}]]},"Path Builder":{"main":[[{"node":"sizeFilter1 sauf pdf","type":"main","index":0}]]},"Edit Fields5":{"main":[[{"node":"Merge5","type":"main","index":0}]]},"Code2":{"main":[[{"node":"Merge5","type":"main","index":1}]]},"Edit Fields4":{"main":[[{"node":"Merge4","type":"main","index":0}]]},"Edit Fields6":{"main":[[{"node":"Merge4","type":"main","index":1}]]},"Merge5":{"main":[[{"node":"Code5","type":"main","index":0}]]},"Merge6":{"main":[[{"node":"Edit Fields6","type":"main","index":0},{"node":"Code2","type":"main","index":0}]]},"Convert to File":{"main":[[{"node":"Upload to Storage1","type":"main","index":0}]]},"Loop Over Items":{"main":[[{"node":"Code4","type":"main","index":0}],[{"node":"Edit Fields9","type":"main","index":0}]]},"Upload to Storage1":{"main":[[{"node":"Edit Fields7","type":"main","index":0}]]},"Supabase2":{"main":[[{"node":"Supabase1","type":"main","index":0}]]},"Edit Fields7":{"main":[[{"node":"Loop Over Items","type":"main","index":0}]]},"Edit Fields8":{"main":[[{"node":"Supabase2","type":"main","index":0}]]},"Edit Fields9":{"main":[[{"node":"Code3","type":"main","index":0}]]},"Code3":{"main":[[{"node":"Convert to File","type":"main","index":0}]]},"Code4":{"main":[[{"node":"Edit Fields8","type":"main","index":0}]]},"When clicking ‚ÄòTest workflow‚Äô":{"main":[[{"node":"_isTestFalse","type":"main","index":0}]]},"Switch":{"main":[[{"node":"Update a message1","type":"main","index":0}],[{"node":"Update a message","type":"main","index":0}],[]]},"regex img":{"main":[[{"node":"nettoyer html","type":"main","index":0}]]},"Code5":{"main":[[{"node":"Information Extractor","type":"main","index":0}]]},"sizeFilter1 sauf pdf":{"main":[[{"node":"If4","type":"main","index":0},{"node":"Upload to Storage","type":"main","index":0}]]},"If1":{"main":[[{"node":"paiement Extractor","type":"main","index":0}],[{"node":"commande extractor","type":"main","index":0}]]},"commande extractor":{"main":[[{"node":"Merge7","type":"main","index":1}]]},"OpenAI Chat Model3":{"ai_languageModel":[[{"node":"paiement Extractor","type":"ai_languageModel","index":0}]]},"Information Extractor":{"main":[[{"node":"If1","type":"main","index":0}]]},"OpenAI Chat Model4":{"ai_languageModel":[[{"node":"Information Extractor","type":"ai_languageModel","index":0}]]},"paiement Extractor":{"main":[[{"node":"Update a row1","type":"main","index":0}]]},"Supabase":{"main":[[]]},"update_email":{"main":[[],[{"node":"Stop and Error1","type":"main","index":0}]]},"Update a row1":{"main":[[{"node":"Edit Fields10","type":"main","index":0}]]},"Edit Fields10":{"main":[[{"node":"Merge7","type":"main","index":0}]]},"_isTestTrue":{"main":[[{"node":"If2","type":"main","index":0}]]},"_isTestFalse":{"main":[[{"node":"If2","type":"main","index":0}]]},"set email test":{"main":[[{"node":"testFrom","type":"main","index":0}]]},"Get many messages":{"main":[[{"node":"Sort","type":"main","index":0}],[]]},"Sort":{"main":[[{"node":"Limit","type":"main","index":0}]]},"Limit":{"main":[[{"node":"set email test","type":"main","index":0}]]},"Get a message":{"main":[[{"node":"Code","type":"main","index":0},{"node":"split attachments","type":"main","index":0},{"node":"Loop Over Items","type":"main","index":0},{"node":"Merge2","type":"main","index":0}],[]]},"nettoyer html":{"main":[[{"node":"n8n_execution_id","type":"main","index":0}]]},"add attach. count":{"main":[[{"node":"Code1","type":"main","index":0}]]},"Code":{"main":[[{"node":"regex img","type":"main","index":0}]]},"Merge2":{"main":[[{"node":"clean internetMessageId","type":"main","index":0}]]},"Move a message1":{"main":[[{"node":"is_complete True1","type":"main","index":0}]]},"Update a message":{"main":[[{"node":"Move a message","type":"main","index":0}]]},"Update a message1":{"main":[[{"node":"Move a message","type":"main","index":0}]]},"clean internetMessageId":{"main":[[{"node":"If3","type":"main","index":0}]]},"date last message":{"main":[[{"node":"conversion utc","type":"main","index":0}]]},"conversion utc":{"main":[[{"node":"Get many messages","type":"main","index":0}]]},"Move a message":{"main":[[{"node":"is_complete True","type":"main","index":0}]]},"clean internet id bis":{"main":[[{"node":"Switch","type":"main","index":0}]]},"date last message1":{"main":[[{"node":"Get many messages1","type":"main","index":0}]]},"n8n_execution_id":{"main":[[{"node":"Insert Email","type":"main","index":0}]]},"Merge7":{"main":[[{"node":"Edit Fields4","type":"main","index":0}]]},"Get many messages2":{"main":[[{"node":"set email test","type":"main","index":0}]]}},"settings":{"executionOrder":"v1","callerPolicy":"workflowsFromSameOwner","errorWorkflow":"4xKLB9RPfrowY9h4"},"staticData":{"node:Schedule Trigger":{"recurrenceRules":[]}},"meta":{"templateCredsSetupCompleted":true},"pinData":{},"versionId":"11c436b6-16f0-4998-9e27-4c915c14782a","triggerCount":1,"shared":[{"createdAt":"2025-11-03T13:24:14.846Z","updatedAt":"2025-11-03T13:24:14.846Z","role":"workflow:owner","workflowId":"lYyEBi0T5sTxgMW7","projectId":"3csiRTB7Dv0MNPzt"}],"tags":[]}